(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();class m{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}mult(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}limit(t){if(this.mag()>t){const e=this.getNormalized();this.x=e.x*t,this.y=e.y*t}return this}getNormalized(){const t=this.mag();return t!==0?new m(this.x/t,this.y/t):new m(0,0)}heading(){return Math.atan2(this.y,this.x)}rotated(t){const e=this.heading()+t,n=this.mag();return new m(Math.cos(e)*n,Math.sin(e)*n)}rotateInPlace(t){const e=this.heading()+t,n=this.mag();return this.x=Math.cos(e)*n,this.y=Math.sin(e)*n,this}dist(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}copy(){return new m(this.x,this.y)}static fromAngle(t,e=1){return new m(Math.cos(t)*e,Math.sin(t)*e)}}function ht(o){return function(){let t=o+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}class M{innerWalls=[];outerWalls=[];checkpoints=[];startPoint=new m(0,0);startAngle=0;seed=0;centerLine=[];trackWidth=120;static FIXED_SIZE=1200;constructor(t,e,n=0){this.seed=n,this.generateSimpleLoopedTrack(M.FIXED_SIZE,M.FIXED_SIZE,n)}generateControlPoints(t,e,n){const s=t/2,i=e/2,a=14,r=Math.min(t,e)*.35,l=r*.75,g=r*1,c=.08,h=[];for(let u=0;u<a;u++){const f=u/a*Math.PI*2;let y=0;n()>.92&&(y=(n()>.5?1:-1)*n()*c*(Math.PI*2/a));const b=f+y,v=g-l,p=l+n()*v,L=s+p*Math.cos(b),z=i+p*Math.sin(b);h.push(new m(L,z))}return h}catmullRomSpline(t,e){const n=[],s=t.length;for(let i=0;i<s;i++){const a=t[(i-1+s)%s],r=t[i],l=t[(i+1)%s],g=t[(i+2)%s];for(let c=0;c<e;c++){const h=c/e,u=h*h,f=u*h,y=.5*((-a.x+3*r.x-3*l.x+g.x)*f+(2*a.x-5*r.x+4*l.x-g.x)*u+(-a.x+l.x)*h+2*r.x),b=.5*((-a.y+3*r.y-3*l.y+g.y)*f+(2*a.y-5*r.y+4*l.y-g.y)*u+(-a.y+l.y)*h+2*r.y);n.push(new m(y,b))}}return n}calculateNormal(t,e,n){const s=e.x-t.x,i=e.y-t.y,a=Math.sqrt(s*s+i*i),r=a>0?s/a:0,l=a>0?i/a:0,g=n.x-e.x,c=n.y-e.y,h=Math.sqrt(g*g+c*c),u=h>0?g/h:0,f=h>0?c/h:0,y=r+u,b=l+f,v=Math.sqrt(y*y+b*b),p=v>0?y/v:0,L=v>0?b/v:0;return new m(-L,p)}generateWallsFromCenterLine(){this.innerWalls=[],this.outerWalls=[],this.checkpoints=[];const t=this.trackWidth/2,e=this.centerLine.length,n=[];let s=null;for(let g=0;g<e;g++){const c=this.centerLine[(g-1+e)%e],h=this.centerLine[g],u=this.centerLine[(g+1)%e];let f=this.calculateNormal(c,h,u);s&&f.x*s.x+f.y*s.y<0&&(f=new m(-f.x,-f.y)),n.push(f),s=f}if(e>1){const g=n[0],c=n[e-1];g.x*c.x+g.y*c.y<0&&(n[0]=new m(-g.x,-g.y))}let i=null,a=null,r=null,l=null;for(let g=0;g<e;g++){const c=this.centerLine[g],h=n[g],u=new m(c.x-h.x*t,c.y-h.y*t),f=new m(c.x+h.x*t,c.y+h.y*t);g===0&&(i=u,a=f),r&&l&&(this.innerWalls.push([r,u]),this.outerWalls.push([l,f]),this.checkpoints.push([u,f])),r=u,l=f}r&&l&&i&&a&&(this.innerWalls.push([r,i]),this.outerWalls.push([l,a]),this.checkpoints.push([i,a]))}findStartPoint(){if(this.checkpoints.length>0){const t=this.checkpoints[0],e=t[0],n=t[1];this.startPoint=new m((e.x+n.x)/2,(e.y+n.y)/2);const s=n.x-e.x,i=n.y-e.y;this.startAngle=Math.atan2(-s,i)}else this.startPoint=new m(M.FIXED_SIZE/2,M.FIXED_SIZE/2),this.startAngle=0}segmentsIntersect(t,e,n,s){const i=e.x-t.x,a=e.y-t.y,r=s.x-n.x,l=s.y-n.y,g=i*l-a*r;if(Math.abs(g)<1e-10)return!1;const c=n.x-t.x,h=n.y-t.y,u=(c*l-h*r)/g,f=(c*a-h*i)/g;return u>.01&&u<.99&&f>.01&&f<.99}hasSelfIntersection(){const t=this.centerLine.length;for(let e=0;e<t;e++){const n=this.centerLine[e],s=this.centerLine[(e+1)%t];for(let i=e+3;i<t-1;i++){const a=this.centerLine[i],r=this.centerLine[(i+1)%t];if(this.segmentsIntersect(n,s,a,r))return!0}}return!1}hasWallIntersection(){const t=this.innerWalls.length;for(let e=0;e<t;e++){const n=this.innerWalls[e];for(let s=0;s<t;s++){if(Math.abs(e-s)<=1||Math.abs(e-s)>=t-1)continue;const i=this.outerWalls[s];if(this.segmentsIntersect(n[0],n[1],i[0],i[1]))return!0}}for(let e=0;e<t;e++){const n=this.innerWalls[e],s=this.outerWalls[e];for(let i=e+3;i<t-1;i++){const a=this.innerWalls[i],r=this.outerWalls[i];if(this.segmentsIntersect(n[0],n[1],a[0],a[1])||this.segmentsIntersect(s[0],s[1],r[0],r[1]))return!0}}return!1}generateSimpleLoopedTrack(t,e,n=0){this.innerWalls=[],this.outerWalls=[],this.checkpoints=[],this.centerLine=[],this.seed=n;const s=n>0?ht(n):null;let i=0;const a=20;for(;i<a;){const r=this.generateControlPoints(t,e,s||(()=>Math.random())),l=15;if(this.centerLine=this.catmullRomSpline(r,l),this.hasSelfIntersection()){i++,i<a&&(this.seed=n+i*1e3);continue}if(this.generateWallsFromCenterLine(),this.hasWallIntersection()){i++,i<a&&(this.seed=n+i*1e3);continue}break}this.findStartPoint()}randomize(t,e){const n=Math.floor(Math.random()*1e6)+1;return this.generateSimpleLoopedTrack(t,e,n),n}draw(t){t.lineWidth=4,t.strokeStyle="#fff",t.beginPath();for(const e of this.outerWalls)t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.stroke(),t.beginPath();for(const e of this.innerWalls)t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.stroke(),this.checkpoints.length>0&&(t.strokeStyle="rgba(0, 255, 0, 0.5)",t.lineWidth=2,t.beginPath(),t.moveTo(this.checkpoints[0][0].x,this.checkpoints[0][0].y),t.lineTo(this.checkpoints[0][1].x,this.checkpoints[0][1].y),t.stroke())}}function D(o,t,e,n){const s=(n.x-e.x)*(o.y-e.y)-(n.y-e.y)*(o.x-e.x),i=(e.y-o.y)*(o.x-t.x)-(e.x-o.x)*(o.y-t.y),a=(n.y-e.y)*(t.x-o.x)-(n.x-e.x)*(t.y-o.y);if(a!==0){const r=s/a,l=i/a;if(r>=0&&r<=1&&l>=0&&l<=1)return{x:o.x+r*(t.x-o.x),y:o.y+r*(t.y-o.y),offset:r}}return null}class B{pos;vel;acc;maxSpeed=5;maxForce=.2;radius=8;heading;isDead=!1;fitness=0;distanceTraveled=0;checkpointCount=0;frameAge=0;life=500;sensorCount=5;sensorRays=[];sensorDistances=[];sensorAngles=[-Math.PI/2,-Math.PI/4,0,Math.PI/4,Math.PI/2];sensorLength=100;network;lastInputs=[0,0,0,0,0];lastOutputs=[0,0];lastHiddenActivations=[[0,0,0,0],[0,0,0,0]];constructor(t,e,n){this.pos=new m(t,e),this.vel=m.fromAngle(n,.1),this.acc=new m(0,0),this.heading=n,this.network=new brain.NeuralNetwork({hiddenLayers:[4,4],activation:"sigmoid"}),this.network.train([{input:[0,0,0,0,0],output:[.5,.5]}],{iterations:1}),this.scrambleWeights()}scrambleWeights(){const t=this.network.toJSON();for(let e=0;e<t.layers.length;e++){const n=t.layers[e];if(n.weights){for(let s=0;s<n.weights.length;s++)for(let i=0;i<n.weights[s].length;i++)n.weights[s][i]=Math.random()*4-2;if(n.biases)for(let s=0;s<n.biases.length;s++)n.biases[s]=Math.random()*4-2}}this.network.fromJSON(t)}calculateHiddenActivations(t){const e=this.network.toJSON();let n=t;for(let s=1;s<e.layers.length;s++){const i=e.layers[s];if(!i.weights)continue;const a=[];for(let r=0;r<i.weights.length;r++){let l=i.biases&&i.biases[r]||0;for(let g=0;g<n.length;g++)l+=(i.weights[r][g]||0)*n[g];a.push(1/(1+Math.exp(-l)))}n=a,s<e.layers.length-1&&(this.lastHiddenActivations[s-1]=a)}}update(t){if(this.isDead||(this.updateSensors(t),this.checkCollisions(t),this.isDead))return;const e=this.sensorDistances.map(g=>g/this.sensorLength);this.lastInputs=e;const n=this.network.run(e);this.lastOutputs=n,this.calculateHiddenActivations(e);const s=n[0],i=n[1]*2-1;this.heading+=i*.1;const a=m.fromAngle(this.heading,s*this.maxForce);this.acc.add(a),this.vel.add(this.acc),this.vel.limit(this.maxSpeed),this.vel=this.vel.mult(.95);const r=new m(this.pos.x,this.pos.y);if(this.pos.add(this.vel),this.acc.mult(0),this.life--,this.life<=0){this.isDead=!0;return}this.checkCheckpoints(t,r),this.frameAge++,this.distanceTraveled+=this.vel.mag();const l=this.checkpointCount>0?this.checkpointCount/this.frameAge*1e4:0;this.fitness=this.checkpointCount*1e3+l}checkCheckpoints(t,e){const n=this.checkpointCount%t.checkpoints.length,s=t.checkpoints[n];D(e,this.pos,s[0],s[1])&&(this.checkpointCount++,this.life+=500,this.life>1e3&&(this.life=1e3))}updateSensors(t){this.sensorRays=[],this.sensorDistances=[];const e=[...t.innerWalls,...t.outerWalls];for(let n=0;n<this.sensorCount;n++){const s=this.heading+this.sensorAngles[n],i=m.fromAngle(s,this.sensorLength),a=new m(this.pos.x+i.x,this.pos.y+i.y);let r=null,l=this.sensorLength;for(const g of e){const c=D(this.pos,a,g[0],g[1]);if(c){const h=this.pos.dist(new m(c.x,c.y));h<l&&(l=h,r=new m(c.x,c.y))}}this.sensorDistances.push(l),r?this.sensorRays.push(r):this.sensorRays.push(a)}}checkCollisions(t){const e=[...t.innerWalls,...t.outerWalls],n=new m(this.pos.x+this.vel.x,this.pos.y+this.vel.y);for(const s of e)if(D(this.pos,n,s[0],s[1])){this.isDead=!0;return}for(let s of this.sensorDistances)if(s<this.radius){this.isDead=!0;return}}draw(t,e=!1){if(!this.isDead){if(e){t.lineWidth=1;for(let n=0;n<this.sensorRays.length;n++){const s=this.sensorDistances[n]/this.sensorLength,i=Math.floor(255*(1-s)),a=Math.floor(255*s);t.strokeStyle=`rgba(${i}, ${a}, 0, 0.5)`,t.beginPath(),t.moveTo(this.pos.x,this.pos.y),t.lineTo(this.sensorRays[n].x,this.sensorRays[n].y),t.stroke()}}t.translate(this.pos.x,this.pos.y),t.rotate(this.heading),t.fillStyle=e?"#00ff00":"rgba(200, 200, 200, 0.5)",t.beginPath(),t.moveTo(this.radius,0),t.lineTo(-this.radius,-this.radius/1.5),t.lineTo(-this.radius,this.radius/1.5),t.closePath(),t.fill(),t.rotate(-this.heading),t.translate(-this.pos.x,-this.pos.y)}}}class q{populationSize=50;mutationRate=.1;boids=[];generation=1;timer=0;maxLifespan=2e3;eliteCount=1;tournamentSize=3;topParentsCount=5;lastGenEndStats=null;bestFitnessThisGen=0;lastImprovementTimer=0;constructor(t,e,n,s){this.populationSize=t;const i=localStorage.getItem("best_boid_brain"),a=localStorage.getItem("current_generation");a&&(this.generation=parseInt(a));for(let r=0;r<t;r++){const l=new B(e,n,s);if(i&&r===0)l.network.fromJSON(JSON.parse(i));else if(i&&r<t*.2){const g=JSON.parse(i);this.mutate(g,.2),l.network.fromJSON(g)}this.boids.push(l)}}update(t){this.timer++;let e=!0,n=0;for(const i of this.boids)i.update(t),i.isDead||(e=!1),i.fitness>n&&(n=i.fitness);n>this.bestFitnessThisGen&&(this.bestFitnessThisGen=n,this.lastImprovementTimer=this.timer);const s=this.maxLifespan-this.timer<=500&&this.timer-this.lastImprovementTimer>=500;(e||this.timer>this.maxLifespan||s)&&(this.nextGeneration(t.startPoint.x,t.startPoint.y,t.startAngle),this.timer=0)}selectParent(){let t=null;for(let e=0;e<this.tournamentSize;e++){const n=Math.floor(Math.random()*this.boids.length),s=this.boids[n];(!t||s.fitness>t.fitness)&&(t=s)}return t}crossover(t,e){const n=JSON.parse(JSON.stringify(t));for(let s=0;s<n.layers.length;s++){const i=n.layers[s],a=e.layers[s];if(i.weights&&a?.weights)for(let r=0;r<i.weights.length;r++)for(let l=0;l<i.weights[r].length;l++){const g=Math.random();i.weights[r][l]=i.weights[r][l]*g+a.weights[r][l]*(1-g)}if(i.biases&&a?.biases)for(let r=0;r<i.biases.length;r++){const l=Math.random();i.biases[r]=i.biases[r]*l+a.biases[r]*(1-l)}}return n}nextGeneration(t,e,n){this.bestFitnessThisGen=0,this.lastImprovementTimer=0,this.lastGenEndStats={generation:this.generation,survivorCount:this.boids.filter(r=>!r.isDead).length,bestFitness:Math.max(...this.boids.map(r=>r.fitness)),diversity:this.calculateDiversity()},this.boids.sort((r,l)=>l.fitness-r.fitness);const s=[],i=this.boids[0];for(let r=0;r<this.eliteCount&&r<this.boids.length;r++){const l=new B(t,e,n);l.network.fromJSON(this.boids[r].network.toJSON()),s.push(l)}const a=Math.floor(this.populationSize*.2);for(let r=s.length;r<a;r++){const l=new B(t,e,n),g=i.network.toJSON();this.mutate(g,.2),l.network.fromJSON(g),s.push(l)}for(;s.length<this.populationSize;){const r=new B(t,e,n),l=this.selectParent(),g=this.selectParent(),c=l.network.toJSON(),h=g.network.toJSON(),u=this.crossover(c,h);this.mutate(u,this.mutationRate),r.network.fromJSON(u),s.push(r)}this.boids=s,this.generation++,localStorage.setItem("best_boid_brain",JSON.stringify(i.network.toJSON())),localStorage.setItem("current_generation",this.generation.toString())}mutate(t,e){for(let n=0;n<t.layers.length;n++){const s=t.layers[n];if(s.weights){for(let i=0;i<s.weights.length;i++)for(let a=0;a<s.weights[i].length;a++)Math.random()<e&&(s.weights[i][a]+=Math.random()*2-1);if(s.biases)for(let i=0;i<s.biases.length;i++)Math.random()<e&&(s.biases[i]+=Math.random()*2-1)}}}getBestActiveBoid(){let t=null,e=-1;for(let n of this.boids)n.fitness>e&&(e=n.fitness,t=n);return t}calculateDiversity(){if(this.boids.length<2)return 0;const t=Math.min(10,this.boids.length),e=[];for(let i=0;i<t;i++){const a=Math.floor(Math.random()*this.boids.length);e.push(this.boids[a].network.toJSON())}let n=0,s=0;for(let i=0;i<e.length;i++)for(let a=i+1;a<e.length;a++)n+=this.networkDistance(e[i],e[a]),s++;return s>0?n/s:0}networkDistance(t,e){let n=0;for(let s=0;s<t.layers.length;s++){const i=t.layers[s],a=e.layers[s];if(i.weights&&a.weights)for(let r=0;r<i.weights.length;r++)for(let l=0;l<i.weights[r].length;l++){const g=(i.weights[r][l]||0)-(a.weights[r]?.[l]||0);n+=g*g}if(i.biases&&a.biases)for(let r=0;r<i.biases.length;r++){const l=(i.biases[r]||0)-(a.biases[r]||0);n+=l*l}}return Math.sqrt(n)}}const d={ga:null,track:null,simulationCanvas:null,camera:{tx:0,ty:0,scale:1},populationSize:50,isFastTraining:!1,isPaused:!1,autoRandomizeTrack:!1,randomizeInterval:10,fitnessHistory:[],aliveHistory:[],diversityHistory:[],fps:0,frameCount:0,lastFpsTime:performance.now()};class gt{panels=new Map;zTop=200;register(t){const e=t.dataset.panelId;this.panels.set(e,t),this.wireDrag(t),this.wireMinimize(t),this.wireClose(t),this.wireFocus(t),this.restorePanelState(t)}wireDrag(t){const e=t.querySelector(".panel-header");if(!e)return;let n=0,s=0,i=0,a=0,r=!1;const l=c=>{if(!r)return;const h=c.clientX-n,u=c.clientY-s;t.style.left=`${Math.max(0,i+h)}px`,t.style.top=`${Math.max(0,a+u)}px`},g=()=>{r&&(r=!1,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",g),this.savePanelState(t))};e.addEventListener("mousedown",c=>{c.target.tagName!=="BUTTON"&&(r=!0,n=c.clientX,s=c.clientY,i=parseInt(t.style.left)||0,a=parseInt(t.style.top)||0,this.bringToFront(t),document.addEventListener("mousemove",l),document.addEventListener("mouseup",g),c.preventDefault())})}wireMinimize(t){const e=t.querySelector(".panel-btn-minimize");e&&e.addEventListener("click",()=>{const n=t.classList.toggle("panel--minimized");if(e.textContent=n?"‚ñ°":"‚àí",n)t.dataset.expandedHeight=String(t.offsetHeight),t.style.height="34px";else{const s=t.dataset.expandedHeight;t.style.height=s?`${s}px`:""}this.savePanelState(t)})}wireClose(t){const e=t.querySelector(".panel-btn-close");e&&e.addEventListener("click",()=>{this.setVisible(t,!1)})}wireFocus(t){t.addEventListener("mousedown",()=>this.bringToFront(t))}bringToFront(t){this.zTop++,t.style.zIndex=String(this.zTop)}setVisible(t,e){t.style.display=e?"flex":"none",this.savePanelState(t);const n=t.dataset.panelId,s=document.querySelector(`[data-toggle-panel="${n}"]`);s&&s.classList.toggle("toolbar-btn--active",e)}toggleVisible(t){const e=this.panels.get(t);if(!e)return;const n=e.style.display!=="none";this.setVisible(e,!n),n||this.bringToFront(e)}savePanelState(t){const e=t.dataset.panelId,n=t.classList.contains("panel--minimized"),s=n&&parseInt(t.dataset.expandedHeight||"0")||t.offsetHeight,i={left:parseInt(t.style.left)||0,top:parseInt(t.style.top)||0,width:t.offsetWidth,height:s,minimized:n,visible:t.style.display!=="none"};localStorage.setItem(`panel_state_${e}`,JSON.stringify(i))}restorePanelState(t){const e=t.dataset.panelId,n=localStorage.getItem(`panel_state_${e}`);if(n)try{const s=JSON.parse(n);if(t.style.left=`${s.left}px`,t.style.top=`${s.top}px`,t.style.width=`${s.width}px`,t.style.display=s.visible?"flex":"none",s.minimized){t.classList.add("panel--minimized"),t.dataset.expandedHeight=String(s.height),t.style.height="34px";const a=t.querySelector(".panel-btn-minimize");a&&(a.textContent="‚ñ°")}else t.style.height=`${s.height}px`;const i=document.querySelector(`[data-toggle-panel="${e}"]`);i&&i.classList.toggle("toolbar-btn--active",s.visible)}catch{}}saveAll(){this.panels.forEach(t=>this.savePanelState(t))}}function ft(o){const t=[];o.layers[1]?.weights?.[0]&&t.push(o.layers[1].weights[0].length);for(let e=1;e<o.layers.length;e++){const n=o.layers[e];n.biases&&t.push(n.biases.length)}return t}function ut(o,t){const e=t.network.toJSON();if(!e.layers||e.layers.length===0)return;const n=o.canvas.width,s=o.canvas.height,i=ft(e);if(i.length===0||n<10||s<10)return;const a=n/i.length,r=Math.max(1,Math.min(14,(s-100)/(Math.max(...i)*2.5))),l=[];for(let c=0;c<i.length;c++){const h=i[c],u=a*c+a/2,f=[],y=(s-80)/(h+1),b=50;for(let v=0;v<h;v++){const p=b+(v+1)*y;f.push({x:u,y:p})}l.push(f)}o.fillStyle="#aaa",o.font="11px Arial",o.textAlign="center";const g=["Input","Hidden 1","Hidden 2","Output"];for(let c=0;c<i.length;c++){const h=a*c+a/2;o.fillText(g[c]||"",h,20),o.fillStyle="#666",o.font="9px Arial",o.fillText(`(${i[c]} nodes)`,h,32),o.fillStyle="#aaa",o.font="11px Arial"}for(let c=1;c<i.length;c++){const h=i[c],u=i[c-1],f=e.layers[c];for(let y=0;y<h;y++){const b=l[c][y];for(let v=0;v<u;v++){const p=l[c-1][v];let L=0;f&&f.weights&&f.weights[y]&&(L=f.weights[y][v]||0);const z=Math.min(1,Math.abs(L)/3);z>.02&&(o.beginPath(),o.lineWidth=1+Math.abs(L)*.5,o.strokeStyle=L>0?`rgba(50, 255, 100, ${z})`:`rgba(255, 80, 80, ${z})`,o.moveTo(p.x,p.y),o.lineTo(b.x,b.y),o.stroke())}}}for(let c=0;c<l.length;c++)for(let h=0;h<l[c].length;h++){const u=l[c][h];let f=.5;if(c===0&&t.lastInputs[h]!==void 0)f=t.lastInputs[h];else if(c===l.length-1&&t.lastOutputs[h]!==void 0)f=t.lastOutputs[h];else if(c>0&&c<l.length-1){const p=c-1;t.lastHiddenActivations[p]?.[h]!==void 0&&(f=t.lastHiddenActivations[p][h])}f>.6?(o.shadowBlur=20,o.shadowColor=`rgba(0, 255, 200, ${f})`):f<.4&&(o.shadowBlur=10,o.shadowColor=`rgba(255, 100, 100, ${1-f})`),o.beginPath(),o.arc(u.x,u.y,r,0,Math.PI*2);let y,b,v;if(f<.5){const p=f*2;y=Math.floor(50*(1-p)+50*p),b=Math.floor(100*(1-p)+200*p),v=Math.floor(200*(1-p)+100*p)}else{const p=(f-.5)*2;y=Math.floor(50*(1-p)+255*p),b=Math.floor(200*(1-p)+200*p),v=Math.floor(100*(1-p)+50*p)}if(o.fillStyle=`rgb(${y}, ${b}, ${v})`,o.fill(),o.shadowBlur=0,o.strokeStyle="#fff",o.lineWidth=2,o.stroke(),o.fillStyle="#fff",o.font="bold 8px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText(f.toFixed(2),u.x,u.y),o.fillStyle="#888",o.font="8px Arial",o.textBaseline="top",c===0){const p=["L","FL","F","FR","R"];o.fillText(p[h]||`S${h+1}`,u.x,u.y+r+2)}else if(c===l.length-1){const p=["Thr","Str"];o.fillText(p[h]||`O${h+1}`,u.x,u.y+r+2)}}}function pt(){const o=O("brain","üß† Brain Visualisation",360,420,20,60),t=document.createElement("canvas");return t.id="network-canvas",t.style.cssText="width:100%;height:100%;display:block;",o.querySelector(".panel-body").appendChild(t),new ResizeObserver(()=>{const n=o.querySelector(".panel-body");t.width=n.clientWidth,t.height=n.clientHeight}).observe(o.querySelector(".panel-body")),o}function mt(){const o=document.querySelector('[data-panel-id="brain"]');if(!o||o.style.display==="none"||o.classList.contains("panel--minimized"))return;const t=document.getElementById("network-canvas");if(!t||!d.ga)return;const e=t.getContext("2d");if(!e)return;const n=d.ga.getBestActiveBoid();e.fillStyle="#111318",e.fillRect(0,0,t.width,t.height),n&&ut(e,n)}function O(o,t,e,n,s,i){const a=document.createElement("div");return a.className="panel",a.dataset.panelId=o,a.style.cssText=`left:${s}px;top:${i}px;width:${e}px;height:${n}px;`,a.innerHTML=`
    <div class="panel-header">
      <span class="panel-title">${t}</span>
      <div class="panel-header-btns">
        <button class="panel-btn panel-btn-minimize" title="Minimise">‚àí</button>
        <button class="panel-btn panel-btn-close"    title="Close">‚úï</button>
      </div>
    </div>
    <div class="panel-body"></div>
  `,a}const E=220,yt=M.FIXED_SIZE,C=E/yt;function vt(){const o=E+16,t=E+16+34,e=O("minimap","üó∫ Minimap",o,t,20,500);e.style.resize="none";const n=e.querySelector(".panel-body");n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.padding="8px";const s=document.createElement("canvas");return s.id="minimap-canvas",s.width=E,s.height=E,s.style.cssText="border-radius:6px;background:#111;display:block;",n.appendChild(s),e}function bt(){const o=document.querySelector('[data-panel-id="minimap"]');if(!o||o.style.display==="none"||o.classList.contains("panel--minimized"))return;const t=document.getElementById("minimap-canvas"),{ga:e,track:n,camera:s}=d;if(!t||!e||!n)return;const i=t.getContext("2d");if(!i)return;i.fillStyle="#0a0c10",i.fillRect(0,0,E,E),i.save(),i.setTransform(C,0,0,C,0,0),n.draw(i);const a=e.getBestActiveBoid();for(const v of e.boids)v.draw(i,v===a);i.restore();const r=window.innerWidth,l=window.innerHeight,{tx:g,ty:c,scale:h}=s,u=-g/h*C,f=-c/h*C,y=r/h*C,b=l/h*C;i.strokeStyle="rgba(99, 179, 255, 0.9)",i.lineWidth=1.5,i.strokeRect(u,f,y,b)}const $=200,x=[],w=[],k=[];let _=-1,G=1,P=0,S=[];(function(){try{const t=localStorage.getItem("nnts_run_history");t&&(S=JSON.parse(t));const e=localStorage.getItem("nnts_chart_fitness"),n=localStorage.getItem("nnts_chart_alive"),s=localStorage.getItem("nnts_chart_diversity"),i=localStorage.getItem("nnts_chart_lastgen"),a=localStorage.getItem("nnts_chart_peak"),r=localStorage.getItem("nnts_chart_startgen");e&&x.push(...JSON.parse(e)),n&&w.push(...JSON.parse(n)),s&&k.push(...JSON.parse(s)),i&&(_=parseInt(i)),a&&(P=parseFloat(a)),r&&(G=parseInt(r))}catch{}})();function St(){const o=O("chart","üìà Training Chart",360,380,window.innerWidth-380,60),t=o.querySelector(".panel-body"),e=document.createElement("div");e.className="chart-controls",e.innerHTML=`
    <label><input type="checkbox" id="chart-show-fitness"   checked> <span style="color:#4ade80">Fitness</span></label>
    <label><input type="checkbox" id="chart-show-alive"     checked> <span style="color:#60a5fa">Survivors</span></label>
    <label><input type="checkbox" id="chart-show-diversity" checked> <span style="color:#f97316">Diversity</span></label>
  `,t.appendChild(e);const n=document.createElement("canvas");n.id="chart-canvas",n.style.cssText="width:100%;display:block;",n.width=340,n.height=180,t.appendChild(n);const s=document.createElement("div");return s.id="chart-run-history",s.style.cssText=["overflow-y:auto","max-height:110px","font-size:0.70rem","color:#aaa","border-top:1px solid rgba(255,255,255,0.08)","padding-top:5px","margin-top:4px","flex-shrink:0"].join(";"),t.appendChild(s),new ResizeObserver(()=>{const a=o.querySelector(".panel-body");n.width=a.clientWidth,n.height=Math.max(80,a.clientHeight-(e.offsetHeight||28)-(s.offsetHeight||120))}).observe(t),o}function X(o){if(x.length===0&&!o.lastGenEndStats)return;const t=o.lastGenEndStats,e=x[x.length-1]??0,n=w[w.length-1]??0,s=k[k.length-1]??0,i={runId:(S[S.length-1]?.runId??0)+1,genCount:(t?.generation??o.generation)-G,peakFitness:P||e,finalSurvivorCount:t?t.survivorCount:Math.round(n/100*d.populationSize),finalSurvivorPct:n,finalDiversity:t?t.diversity:s,timestamp:Date.now()};S.push(i),S.length>50&&S.shift(),localStorage.setItem("nnts_run_history",JSON.stringify(S))}function Z(){x.length=0,w.length=0,k.length=0,_=-1,P=0,localStorage.removeItem("nnts_chart_fitness"),localStorage.removeItem("nnts_chart_alive"),localStorage.removeItem("nnts_chart_diversity"),localStorage.removeItem("nnts_chart_lastgen"),localStorage.removeItem("nnts_chart_peak"),localStorage.removeItem("nnts_chart_startgen")}function Y(o){G=o,localStorage.setItem("nnts_chart_startgen",String(o))}function xt(){S.length=0,localStorage.removeItem("nnts_run_history")}function wt(){const{ga:o}=d;if(!o)return;const t=o.lastGenEndStats;if(!t||t.generation===_)return;_=t.generation;const e=t.bestFitness,n=t.survivorCount/d.populationSize*100,s=t.diversity;P=Math.max(P,e),x.push(e),w.push(n),k.push(s),x.length>$&&x.shift(),w.length>$&&w.shift(),k.length>$&&k.shift(),localStorage.setItem("nnts_chart_fitness",JSON.stringify(x)),localStorage.setItem("nnts_chart_alive",JSON.stringify(w)),localStorage.setItem("nnts_chart_diversity",JSON.stringify(k)),localStorage.setItem("nnts_chart_lastgen",String(_)),localStorage.setItem("nnts_chart_peak",String(P))}function kt(){const o=document.querySelector('[data-panel-id="chart"]');if(!o||o.style.display==="none"||o.classList.contains("panel--minimized"))return;const t=document.getElementById("chart-canvas");if(!t)return;const e=t.getContext("2d");if(!e)return;const n=t.width,s=t.height;e.fillStyle="#0d0f14",e.fillRect(0,0,n,s),e.strokeStyle="rgba(255,255,255,0.06)",e.lineWidth=1;for(let c=0;c<=4;c++){const h=s*(c/4);e.beginPath(),e.moveTo(0,h),e.lineTo(n,h),e.stroke()}const i=document.getElementById("chart-show-fitness")?.checked??!0,a=document.getElementById("chart-show-alive")?.checked??!0,r=document.getElementById("chart-show-diversity")?.checked??!0;W(e,x,"#4ade80",n,s,i),W(e,w,"#60a5fa",n,s,a,0,100),W(e,k,"#f97316",n,s,r),e.fillStyle="#555",e.font="10px Inter,sans-serif",e.textAlign="right",e.fillText(`gen ${d.ga?.generation??0}`,n-4,s-4);const l=document.getElementById("chart-run-history");if(!l)return;if(S.length===0){l.innerHTML='<span style="color:#444;font-size:0.68rem;">No completed runs yet.</span>';return}const g=[...S].reverse().map(c=>{const h=new Date(c.timestamp),u=y=>String(y).padStart(2,"0"),f=`${h.getMonth()+1}/${h.getDate()} ${h.getHours()}:${u(h.getMinutes())}`;return`<tr>
          <td style="padding:1px 4px;color:#888">#${c.runId}</td>
          <td style="padding:1px 4px">${c.genCount}</td>
          <td style="padding:1px 4px;color:#4ade80">${Math.floor(c.peakFitness).toLocaleString()}</td>
          <td style="padding:1px 4px;color:#60a5fa">${Math.round(c.finalSurvivorPct)}%</td>
          <td style="padding:1px 4px;color:#f97316">${c.finalDiversity.toFixed(2)}</td>
          <td style="padding:1px 4px;color:#555">${f}</td>
        </tr>`}).join("");l.innerHTML=`<table style="width:100%;border-collapse:collapse;line-height:1.4;">
      <thead><tr style="color:#444;border-bottom:1px solid rgba(255,255,255,0.06);">
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Run</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Gens</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Peak</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Surv</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Div</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Date</th>
      </tr></thead>
      <tbody>${g}</tbody>
    </table>`}function W(o,t,e,n,s,i,a,r){if(!i||t.length<2)return;const l=a??Math.min(...t),c=(r??Math.max(...t))-l||1;o.beginPath(),o.strokeStyle=e,o.lineWidth=1.5,o.shadowColor=e,o.shadowBlur=4;for(let h=0;h<t.length;h++){const u=h/(t.length-1)*n,f=s-(t[h]-l)/c*(s-4)-2;h===0?o.moveTo(u,f):o.lineTo(u,f)}o.stroke(),o.shadowBlur=0}function It(){const o=O("config","‚öôÔ∏è Config",300,400,window.innerWidth-325,330),t=o.querySelector(".panel-body");t.style.overflowY="auto",t.style.padding="10px 14px",t.innerHTML=`
    <div class="cfg-section">
      <div class="cfg-label">Population Size</div>
      <div class="cfg-row">
        <input type="range" id="cfg-pop-size" min="10" max="200" step="5" value="${d.populationSize}">
        <span class="cfg-value" id="cfg-pop-size-val">${d.populationSize}</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Mutation Rate</div>
      <div class="cfg-row">
        <input type="range" id="cfg-mutation" min="0.01" max="0.5" step="0.01" value="0.1">
        <span class="cfg-value" id="cfg-mutation-val">0.10</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Tournament Size</div>
      <div class="cfg-row">
        <input type="range" id="cfg-tournament" min="2" max="10" step="1" value="3">
        <span class="cfg-value" id="cfg-tournament-val">3</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Elite Count</div>
      <div class="cfg-row">
        <input type="range" id="cfg-elite" min="1" max="10" step="1" value="1">
        <span class="cfg-value" id="cfg-elite-val">1</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Max Lifespan (frames)</div>
      <div class="cfg-row">
        <input type="range" id="cfg-lifespan" min="200" max="5000" step="100" value="2000">
        <span class="cfg-value" id="cfg-lifespan-val">2000</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Track Options</div>
      <div class="cfg-row-v">
        <button id="cfg-btn-randomize">üîÄ Randomize Track</button>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
          <input type="checkbox" id="cfg-auto-randomize">
          <label for="cfg-auto-randomize" style="font-size:0.85rem;">Auto-randomize every</label>
          <input type="number" id="cfg-auto-gens" min="1" max="100" value="${d.randomizeInterval}"
                 style="width:46px;background:#1a1a2e;border:1px solid #333;color:#ddd;border-radius:4px;padding:2px 4px;font-size:0.85rem;">
          <span style="font-size:0.85rem;">gen</span>
        </div>
        <div style="margin-top:6px;font-size:0.8rem;color:#666;">
          Seed: <span id="cfg-track-seed">Default</span>
        </div>
      </div>
    </div>

    <div class="cfg-section">
      <button id="cfg-btn-fast" class="cfg-btn-danger">‚ö° Toggle Fast Training</button>
    </div>
  `,N(t,"cfg-pop-size","cfg-pop-size-val",s=>{d.populationSize=s}),N(t,"cfg-mutation","cfg-mutation-val",s=>{d.ga&&(d.ga.mutationRate=s)},2),N(t,"cfg-tournament","cfg-tournament-val",s=>{if(!d.ga)return;const i=Math.min(s,d.populationSize-1);if(d.ga.tournamentSize=i,i!==s){const a=t.querySelector("#cfg-tournament"),r=t.querySelector("#cfg-tournament-val");a&&(a.value=String(i)),r&&(r.textContent=String(i))}}),N(t,"cfg-elite","cfg-elite-val",s=>{if(!d.ga)return;const i=Math.min(s,d.populationSize-2);if(d.ga.eliteCount=i,i!==s){const a=t.querySelector("#cfg-elite"),r=t.querySelector("#cfg-elite-val");a&&(a.value=String(i)),r&&(r.textContent=String(i))}}),N(t,"cfg-lifespan","cfg-lifespan-val",s=>{d.ga&&(d.ga.maxLifespan=s)}),t.querySelector("#cfg-btn-randomize")?.addEventListener("click",()=>{if(!d.track||!d.ga)return;const s=d.track.randomize(1200,1200),i=document.getElementById("cfg-track-seed");i&&(i.textContent=String(s)),Mt()});const e=t.querySelector("#cfg-auto-randomize");e?.addEventListener("change",()=>{d.autoRandomizeTrack=e.checked}),t.querySelector("#cfg-auto-gens")?.addEventListener("change",s=>{const i=parseInt(s.target.value);!isNaN(i)&&i>0&&(d.randomizeInterval=i)});const n=t.querySelector("#cfg-btn-fast");return n?.addEventListener("click",()=>{d.isFastTraining=!d.isFastTraining,n.textContent=d.isFastTraining?"üê¢ Toggle Normal Viz":"‚ö° Toggle Fast Training"}),o}function Lt(){const o=document.querySelector('[data-panel-id="config"]');if(!o||o.style.display==="none")return;const t=document.getElementById("cfg-track-seed");t&&d.track&&(t.textContent=d.track.seed===0?"Default":String(d.track.seed))}function N(o,t,e,n,s=0){const i=o.querySelector(`#${t}`),a=o.querySelector(`#${e}`);!i||!a||i.addEventListener("input",()=>{const r=parseFloat(i.value);a.textContent=r.toFixed(s),n(r)})}function Mt(){const{ga:o,track:t}=d;if(!(!o||!t)){for(const e of o.boids)e.pos.x=t.startPoint.x,e.pos.y=t.startPoint.y,e.heading=t.startAngle,e.isDead=!1,e.fitness=0,e.distanceTraveled=0,e.checkpointCount=0,e.life=500;o.timer=0}}function Et(){const o=O("saveload","üíæ Save / Load",280,310,window.innerWidth-305,window.innerHeight-330),t=o.querySelector(".panel-body");return t.style.padding="12px 14px",t.style.gap="8px",t.style.display="flex",t.style.flexDirection="column",t.innerHTML=`
    <div class="sl-section">
      <div class="sl-title">Brain</div>
      <button id="sl-btn-export">‚¨á Export Best Brain (.json)</button>
      <button id="sl-btn-import">‚¨Ü Import Brain (.json)</button>
    </div>
    <div class="sl-section">
      <div class="sl-title">Session</div>
      <button id="sl-btn-save-session">üì¶ Save Session</button>
      <button id="sl-btn-load-session">üìÇ Load Session</button>
    </div>
    <div class="sl-section">
      <div class="sl-title">Generation</div>
      <button id="sl-btn-restart">‚Ü© Restart Generation</button>
      <button id="sl-btn-clear" class="sl-btn-danger">üóë Clear History</button>
    </div>
    <div id="sl-status" style="font-size:0.78rem;color:#888;min-height:18px;"></div>
  `,t.querySelector("#sl-btn-export")?.addEventListener("click",Tt),t.querySelector("#sl-btn-import")?.addEventListener("click",Ct),t.querySelector("#sl-btn-save-session")?.addEventListener("click",Pt),t.querySelector("#sl-btn-load-session")?.addEventListener("click",Ot),t.querySelector("#sl-btn-restart")?.addEventListener("click",()=>{const{ga:e,track:n}=d;!e||!n||(X(e),Z(),d.ga=new q(d.populationSize,n.startPoint.x,n.startPoint.y,n.startAngle),d.ga.generation=1,Y(1),I("Generation restarted."))}),t.querySelector("#sl-btn-clear")?.addEventListener("click",()=>{if(!confirm("Clear all training history? This will reset the brain."))return;const{ga:e,track:n}=d;e&&X(e),xt(),Z(),localStorage.removeItem("best_boid_brain"),localStorage.removeItem("current_generation"),n&&(d.ga=new q(d.populationSize,n.startPoint.x,n.startPoint.y,n.startAngle),d.ga.generation=1,Y(1),I("History cleared."))}),o}function I(o){const t=document.getElementById("sl-status");t&&(t.textContent=o,setTimeout(()=>{t&&(t.textContent="")},3e3))}function Tt(){const{ga:o}=d;if(!o)return;const t=o.boids.reduce((n,s)=>s.fitness>n.fitness?s:n,o.boids[0]);if(!t)return;const e={generation:o.generation,fitness:t.fitness,network:t.network.toJSON(),exportedAt:new Date().toISOString()};rt(e,`brain-gen${o.generation}-fit${Math.floor(t.fitness)}.json`),I(`Exported gen ${o.generation}.`)}function Ct(){lt(".json",async o=>{try{const t=JSON.parse(await o.text());if(!t.network?.layers){I("‚ùå Invalid brain file");return}const{ga:e}=d;if(!e)return;e.boids[0].network.fromJSON(t.network),localStorage.setItem("best_boid_brain",JSON.stringify(t.network)),t.generation&&(e.generation=t.generation,localStorage.setItem("current_generation",String(t.generation))),I(`‚úÖ Brain imported (gen ${t.generation??"?"}, fit ${Math.floor(t.fitness??0)})`)}catch(t){I(`‚ùå ${t.message}`)}})}function Pt(){const{ga:o,track:t}=d;if(!o||!t)return;const e=o.getBestActiveBoid(),n={generation:o.generation,trackSeed:t.seed,bestBrainJSON:e?e.network.toJSON():null,savedAt:new Date().toISOString()};rt(n,`session-gen${o.generation}-${Date.now()}.json`),I("Session saved.")}function Ot(){lt(".json",async o=>{try{const t=JSON.parse(await o.text()),{ga:e}=d;if(!e)return;t.generation&&(e.generation=t.generation),t.bestBrainJSON&&(e.boids[0].network.fromJSON(t.bestBrainJSON),localStorage.setItem("best_boid_brain",JSON.stringify(t.bestBrainJSON))),t.trackSeed&&d.track&&d.track.generateSimpleLoopedTrack(1200,1200,t.trackSeed),I(`‚úÖ Session loaded (gen ${t.generation??"?"})`)}catch(t){I(`‚ùå ${t.message}`)}})}function rt(o,t){const e=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),s=document.createElement("a");s.href=n,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function lt(o,t){const e=document.createElement("input");e.type="file",e.accept=o,e.onchange=n=>{const s=n.target.files?.[0];s&&t(s)},e.click()}const U=200;let H=[];function zt(){const o=O("debug","üêõ Debug",320,380,390,60),t=o.querySelector(".panel-body");return t.style.display="flex",t.style.flexDirection="column",t.style.padding="10px 12px",t.style.gap="6px",t.innerHTML=`
    <div class="dbg-stats">
      <div class="dbg-row"><span>FPS</span><span id="dbg-fps">‚Äî</span></div>
      <div class="dbg-row"><span>Generation</span><span id="dbg-gen">‚Äî</span></div>
      <div class="dbg-row"><span>Frames Left</span><span id="dbg-frames">‚Äî</span></div>
      <div class="dbg-row"><span>Alive</span><span id="dbg-alive">‚Äî</span></div>
      <div class="dbg-row"><span>Best Fitness</span><span id="dbg-fitness">‚Äî</span></div>
      <div class="dbg-row"><span>Diversity</span><span id="dbg-diversity">‚Äî</span></div>
    </div>
    <div class="dbg-section-title">Best Boid I/O</div>
    <div class="dbg-stats" id="dbg-io"></div>
    <div class="dbg-section-title" style="display:flex;justify-content:space-between;">
      Console Log <button id="dbg-clear-log" style="font-size:0.75rem;padding:1px 6px;">Clear</button>
    </div>
    <textarea id="dbg-log" readonly style="flex:1;resize:none;background:#0a0c10;border:1px solid #222;border-radius:6px;color:#8be;font-family:monospace;font-size:0.72rem;padding:6px;overflow-y:auto;"></textarea>
  `,t.querySelector("#dbg-clear-log")?.addEventListener("click",()=>{H=[];const e=document.getElementById("dbg-log");e&&(e.value="")}),o}function Nt(){const o=document.querySelector('[data-panel-id="debug"]');if(!o||o.style.display==="none")return;const{ga:t,fps:e}=d;if(!t)return;F("dbg-fps",e.toFixed(1)),F("dbg-gen",String(t.generation)),F("dbg-frames",String(Math.max(0,t.maxLifespan-t.timer)));const n=t.boids.filter(a=>!a.isDead).length;F("dbg-alive",`${n} / ${d.populationSize}`);const s=t.getBestActiveBoid();if(F("dbg-fitness",s?Math.floor(s.fitness).toString():"‚Äî"),t.timer%15===0){const a=t.calculateDiversity(),r=document.getElementById("dbg-diversity");r&&(r.textContent=a.toFixed(2),r.style.color=a<1?"#f87171":a<3?"#fb923c":"#4ade80")}const i=document.getElementById("dbg-io");if(i&&s){const a=["L","FL","F","FR","R"],r=["Thr","Str"];let l="";s.lastInputs.forEach((g,c)=>{l+=`<div class="dbg-row"><span>In[${a[c]||c}]</span><span>${g.toFixed(3)}</span></div>`}),s.lastOutputs.forEach((g,c)=>{l+=`<div class="dbg-row"><span>Out[${r[c]||c}]</span><span>${g.toFixed(3)}</span></div>`}),i.innerHTML=l}if(H.length){const a=document.getElementById("dbg-log");if(a){const r=H.splice(0);a.value+=r.join(`
`)+`
`;const l=a.value.split(`
`);l.length>U&&(a.value=l.slice(-U).join(`
`)),a.scrollTop=a.scrollHeight}}}function F(o,t){const e=document.getElementById(o);e&&(e.textContent=t)}let A;const V=50,T=M.FIXED_SIZE,Ft=46,K=1.25,Q=.07;function tt(){const o=d.simulationCanvas;o&&(o.width=window.innerWidth,o.height=window.innerHeight-Ft)}function _t(o){const{tx:t,ty:e,scale:n}=d.camera;o.setTransform(n,0,0,n,t,e)}function j(o){o.setTransform(1,0,0,1,0,0)}function R(){const o=d.simulationCanvas;if(!o)return;const t=o.width,e=o.height,n=Math.min(t,e)/T*.9;d.camera.scale=n,d.camera.tx=(t-T*n)/2,d.camera.ty=(e-T*n)/2,ct()}function et(o){const t=d.simulationCanvas;if(!t)return;const{tx:e,ty:n,scale:s}=d.camera,i=t.width/2,a=t.height/2,r=Math.min(8,Math.max(.1,s*o));d.camera.tx=i-(i-e)*(r/s),d.camera.ty=a-(a-n)*(r/s),d.camera.scale=r,ct()}function Bt(){const{ga:o,simulationCanvas:t,camera:e}=d;if(!o||!t)return;const n=o.getBestActiveBoid();if(!n)return;const{scale:s}=e,i=t.width/2-n.pos.x*s,a=t.height/2-n.pos.y*s;e.tx+=(i-e.tx)*Q,e.ty+=(a-e.ty)*Q}function Dt(){["brain","minimap","chart","config","saveload","debug"].forEach(o=>{localStorage.removeItem(`panel_state_${o}`)}),location.reload()}function nt(){const o=document.getElementById("simulation-canvas");d.simulationCanvas=o,tt(),window.addEventListener("resize",()=>{tt(),R()}),R();const t=new M(T,T),e=new q(V,t.startPoint.x,t.startPoint.y,t.startAngle);d.track=t,d.ga=e,d.populationSize=V,A=new gt;const n=document.getElementById("panel-layer");[pt(),vt(),St(),It(),Et(),zt()].forEach(a=>{n.appendChild(a),A.register(a)}),document.querySelectorAll("[data-toggle-panel]").forEach(a=>{const r=a.dataset.togglePanel;a.addEventListener("click",()=>A.toggleVisible(r))}),document.getElementById("btn-zoom-in")?.addEventListener("click",()=>et(K)),document.getElementById("btn-zoom-out")?.addEventListener("click",()=>et(1/K)),document.getElementById("btn-zoom-reset")?.addEventListener("click",R),document.getElementById("btn-reset-panels")?.addEventListener("click",Dt);const i=document.getElementById("btn-pause");i?.addEventListener("click",()=>{d.isPaused=!d.isPaused,i&&(i.textContent=d.isPaused?"‚ñ∂ Resume":"‚è∏ Pause",i.classList.toggle("toolbar-btn--active",d.isPaused))}),o.addEventListener("contextmenu",a=>a.preventDefault()),requestAnimationFrame(dt)}function ct(){const o=Math.round(d.camera.scale*100),t=document.getElementById("toolbar-zoom");t&&(t.textContent=`${o}%`)}let st=0;function it(){const{ga:o,track:t}=d;!o||!t||(st=o.generation,o.update(t),d.autoRandomizeTrack&&o.generation>st&&o.generation%d.randomizeInterval===0&&t.randomize(T,T))}function ot(){const o=d.simulationCanvas,{ga:t,track:e}=d;if(!o||!t||!e)return;const n=o.getContext("2d");j(n),n.fillStyle="#0a0c10",n.fillRect(0,0,o.width,o.height),_t(n),e.draw(n);const s=t.getBestActiveBoid();for(const i of t.boids)i.draw(n,i===s);j(n)}let at=performance.now(),J=0;function $t(o){J++;const t=o-at;t>=500&&(d.fps=J/t*1e3,J=0,at=o)}function dt(o){if($t(o),d.isPaused)ot();else if(d.isFastTraining){for(let n=0;n<20;n++)it();const t=d.simulationCanvas,{ga:e}=d;if(t&&e){const n=t.getContext("2d");j(n),n.fillStyle="#0a0c10",n.fillRect(0,0,t.width,t.height),n.fillStyle="rgba(99,102,241,0.8)",n.font="bold 48px Inter,sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(`‚ö° FAST TRAINING ‚Äî GEN ${e.generation}`,t.width/2,t.height/2)}}else Bt(),it(),ot();wt(),mt(),bt(),kt(),Lt(),Nt(),requestAnimationFrame(dt)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",nt):nt();
