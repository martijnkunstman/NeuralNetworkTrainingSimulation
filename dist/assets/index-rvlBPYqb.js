(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();class m{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}mult(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}limit(t){if(this.mag()>t){const e=this.getNormalized();this.x=e.x*t,this.y=e.y*t}return this}getNormalized(){const t=this.mag();return t!==0?new m(this.x/t,this.y/t):new m(0,0)}heading(){return Math.atan2(this.y,this.x)}rotated(t){const e=this.heading()+t,n=this.mag();return new m(Math.cos(e)*n,Math.sin(e)*n)}rotateInPlace(t){const e=this.heading()+t,n=this.mag();return this.x=Math.cos(e)*n,this.y=Math.sin(e)*n,this}dist(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}copy(){return new m(this.x,this.y)}static fromAngle(t,e=1){return new m(Math.cos(t)*e,Math.sin(t)*e)}}function tt(o){return function(){let t=o+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}class x{innerWalls=[];outerWalls=[];checkpoints=[];startPoint=new m(0,0);startAngle=0;seed=0;centerLine=[];controlPoints=[];trackWidth=120;numControlPoints=14;segmentsPerCurve=15;radiusVariance=.35;cornerTightness=.2;lastValidControlPoints=[];static FIXED_SIZE=1200;constructor(t,e,n=0){this.seed=n,this.generateSimpleLoopedTrack(x.FIXED_SIZE,x.FIXED_SIZE,n)}generateControlPoints(t,e,n){const s=t/2,i=e/2,r=this.numControlPoints,a=Math.min(t,e)*.35,l=a*Math.max(.1,1-this.radiusVariance),h=a*(1+this.radiusVariance*.5),d=this.cornerTightness,g=[];for(let f=0;f<r;f++){const u=f/r*Math.PI*2;let y=0;n()>1-this.cornerTightness*1.5&&(y=(n()>.5?1:-1)*n()*d*(Math.PI*2/r));const v=u+y,b=h-l,p=l+n()*b;g.push(new m(s+p*Math.cos(v),i+p*Math.sin(v)))}return this.controlPoints=g,g}catmullRomSpline(t,e){const n=[],s=t.length;for(let i=0;i<s;i++){const r=t[(i-1+s)%s],a=t[i],l=t[(i+1)%s],h=t[(i+2)%s];for(let d=0;d<e;d++){const g=d/e,f=g*g,u=f*g,y=.5*((-r.x+3*a.x-3*l.x+h.x)*u+(2*r.x-5*a.x+4*l.x-h.x)*f+(-r.x+l.x)*g+2*a.x),v=.5*((-r.y+3*a.y-3*l.y+h.y)*u+(2*r.y-5*a.y+4*l.y-h.y)*f+(-r.y+l.y)*g+2*a.y);n.push(new m(y,v))}}return n}calculateNormal(t,e,n){const s=e.x-t.x,i=e.y-t.y,r=Math.sqrt(s*s+i*i),a=r>0?s/r:0,l=r>0?i/r:0,h=n.x-e.x,d=n.y-e.y,g=Math.sqrt(h*h+d*d),f=g>0?h/g:0,u=g>0?d/g:0,y=a+f,v=l+u,b=Math.sqrt(y*y+v*v),p=b>0?y/b:0,C=b>0?v/b:0;return new m(-C,p)}generateWallsFromCenterLine(){this.innerWalls=[],this.outerWalls=[],this.checkpoints=[];const t=this.trackWidth/2,e=this.centerLine.length,n=[];let s=null;for(let h=0;h<e;h++){const d=this.centerLine[(h-1+e)%e],g=this.centerLine[h],f=this.centerLine[(h+1)%e];let u=this.calculateNormal(d,g,f);s&&u.x*s.x+u.y*s.y<0&&(u=new m(-u.x,-u.y)),n.push(u),s=u}if(e>1){const h=n[0],d=n[e-1];h.x*d.x+h.y*d.y<0&&(n[0]=new m(-h.x,-h.y))}let i=null,r=null,a=null,l=null;for(let h=0;h<e;h++){const d=this.centerLine[h],g=n[h],f=new m(d.x-g.x*t,d.y-g.y*t),u=new m(d.x+g.x*t,d.y+g.y*t);h===0&&(i=f,r=u),a&&l&&(this.innerWalls.push([a,f]),this.outerWalls.push([l,u]),this.checkpoints.push([f,u])),a=f,l=u}a&&l&&i&&r&&(this.innerWalls.push([a,i]),this.outerWalls.push([l,r]),this.checkpoints.push([i,r]))}findStartPoint(){if(this.checkpoints.length>0){const t=this.checkpoints[0],e=t[0],n=t[1];this.startPoint=new m((e.x+n.x)/2,(e.y+n.y)/2);const s=n.x-e.x,i=n.y-e.y;this.startAngle=Math.atan2(-s,i)}else this.startPoint=new m(x.FIXED_SIZE/2,x.FIXED_SIZE/2),this.startAngle=0}segmentsIntersect(t,e,n,s){const i=e.x-t.x,r=e.y-t.y,a=s.x-n.x,l=s.y-n.y,h=i*l-r*a;if(Math.abs(h)<1e-10)return!1;const d=n.x-t.x,g=n.y-t.y,f=(d*l-g*a)/h,u=(d*r-g*i)/h;return f>.01&&f<.99&&u>.01&&u<.99}hasSelfIntersection(){const t=this.centerLine.length;for(let e=0;e<t;e++){const n=this.centerLine[e],s=this.centerLine[(e+1)%t];for(let i=e+3;i<t-1;i++){const r=this.centerLine[i],a=this.centerLine[(i+1)%t];if(this.segmentsIntersect(n,s,r,a))return!0}}return!1}hasWallIntersection(){const t=this.innerWalls.length;for(let e=0;e<t;e++){const n=this.innerWalls[e];for(let s=0;s<t;s++){if(Math.abs(e-s)<=1||Math.abs(e-s)>=t-1)continue;const i=this.outerWalls[s];if(this.segmentsIntersect(n[0],n[1],i[0],i[1]))return!0}}for(let e=0;e<t;e++){const n=this.innerWalls[e],s=this.outerWalls[e];for(let i=e+3;i<t-1;i++){const r=this.innerWalls[i],a=this.outerWalls[i];if(this.segmentsIntersect(n[0],n[1],r[0],r[1])||this.segmentsIntersect(s[0],s[1],a[0],a[1]))return!0}}return!1}generateSimpleLoopedTrack(t,e,n=0){this.innerWalls=[],this.outerWalls=[],this.checkpoints=[],this.centerLine=[],this.seed=n;const s=n>0?tt(n):null;let i=0;const r=250;let a=!1;for(;i<r;){const l=this.generateControlPoints(t,e,s||(()=>Math.random()));if(this.centerLine=this.catmullRomSpline(l,this.segmentsPerCurve),this.hasSelfIntersection()){i++,i<r&&(this.seed=n+i*1e3);continue}if(this.generateWallsFromCenterLine(),this.hasWallIntersection()){i++,i<r&&(this.seed=n+i*1e3);continue}this.lastValidControlPoints=this.controlPoints.map(h=>new m(h.x,h.y)),a=!0;break}if(!a){const l=this.radiusVariance,h=this.cornerTightness,d=this.numControlPoints;this.radiusVariance=.05,this.cornerTightness=.05,this.numControlPoints=10,this.generateControlPoints(t,e,tt(42)),this.centerLine=this.catmullRomSpline(this.controlPoints,this.segmentsPerCurve),this.generateWallsFromCenterLine(),this.lastValidControlPoints=this.controlPoints.map(g=>new m(g.x,g.y)),this.radiusVariance=l,this.cornerTightness=h,this.numControlPoints=d}this.findStartPoint()}randomize(t,e){const n=Math.floor(Math.random()*1e6)+1;return this.generateSimpleLoopedTrack(t,e,n),n}draw(t){t.lineWidth=4,t.strokeStyle="#fff",t.beginPath();for(const e of this.outerWalls)t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.stroke(),t.beginPath();for(const e of this.innerWalls)t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.stroke(),this.checkpoints.length>0&&(t.strokeStyle="rgba(0, 255, 0, 0.5)",t.lineWidth=2,t.beginPath(),t.moveTo(this.checkpoints[0][0].x,this.checkpoints[0][0].y),t.lineTo(this.checkpoints[0][1].x,this.checkpoints[0][1].y),t.stroke())}regenerateFromControlPoints(){if(this.controlPoints.length<3)return!1;const t=this.controlPoints.map(e=>new m(e.x,e.y));return this.centerLine=this.catmullRomSpline(this.controlPoints,this.segmentsPerCurve),this.generateWallsFromCenterLine(),this.hasSelfIntersection()||this.hasWallIntersection()?(this.lastValidControlPoints.length>0&&(this.controlPoints=this.lastValidControlPoints.map(e=>new m(e.x,e.y)),this.centerLine=this.catmullRomSpline(this.controlPoints,this.segmentsPerCurve),this.generateWallsFromCenterLine()),this.findStartPoint(),!1):(this.lastValidControlPoints=t,this.findStartPoint(),!0)}drawEditOverlay(t,e){t.fillStyle="rgba(0,0,0,0.45)",t.fillRect(0,0,x.FIXED_SIZE,x.FIXED_SIZE),t.strokeStyle="rgba(255,255,255,0.2)",t.lineWidth=1,t.setLineDash([5,5]),t.beginPath();for(let n=0;n<this.controlPoints.length;n++){const s=this.controlPoints[n];n===0?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y)}t.closePath(),t.stroke(),t.setLineDash([]),t.font="bold 10px Inter,sans-serif",t.textAlign="center",t.textBaseline="middle";for(let n=0;n<this.controlPoints.length;n++){const s=this.controlPoints[n],i=n===e;t.beginPath(),t.arc(s.x,s.y,i?14:10,0,Math.PI*2),t.fillStyle=i?"#f59e0b":"#ffffff",t.fill(),t.strokeStyle="#000",t.lineWidth=2,t.stroke(),t.fillStyle="#000",t.fillText(String(n),s.x,s.y)}t.fillStyle="rgba(245,158,11,0.9)",t.font="bold 18px Inter,sans-serif",t.textAlign="center",t.textBaseline="top",t.fillText("‚úèÔ∏è TRACK EDIT MODE ‚Äî drag the numbered dots",x.FIXED_SIZE/2,18)}}function $(o,t,e,n){const s=(n.x-e.x)*(o.y-e.y)-(n.y-e.y)*(o.x-e.x),i=(e.y-o.y)*(o.x-t.x)-(e.x-o.x)*(o.y-t.y),r=(n.y-e.y)*(t.x-o.x)-(n.x-e.x)*(t.y-o.y);if(r!==0){const a=s/r,l=i/r;if(a>=0&&a<=1&&l>=0&&l<=1)return{x:o.x+a*(t.x-o.x),y:o.y+a*(t.y-o.y),offset:a}}return null}class _{pos;vel;acc;maxSpeed=5;maxForce=.2;radius=8;heading;isDead=!1;fitness=0;distanceTraveled=0;checkpointCount=0;frameAge=0;life=500;sensorCount=5;sensorRays=[];sensorDistances=[];sensorAngles=[-Math.PI/2,-Math.PI/4,0,Math.PI/4,Math.PI/2];sensorLength=100;network;lastInputs=[0,0,0,0,0];lastOutputs=[0,0];lastHiddenActivations=[[0,0,0,0],[0,0,0,0]];constructor(t,e,n){this.pos=new m(t,e),this.vel=m.fromAngle(n,.1),this.acc=new m(0,0),this.heading=n,this.network=new brain.NeuralNetwork({hiddenLayers:[4,4],activation:"sigmoid"}),this.network.train([{input:[0,0,0,0,0],output:[.5,.5]}],{iterations:1}),this.scrambleWeights()}scrambleWeights(){const t=this.network.toJSON();for(let e=0;e<t.layers.length;e++){const n=t.layers[e];if(n.weights){for(let s=0;s<n.weights.length;s++)for(let i=0;i<n.weights[s].length;i++)n.weights[s][i]=Math.random()*4-2;if(n.biases)for(let s=0;s<n.biases.length;s++)n.biases[s]=Math.random()*4-2}}this.network.fromJSON(t)}calculateHiddenActivations(t){const e=this.network.toJSON();let n=t;for(let s=1;s<e.layers.length;s++){const i=e.layers[s];if(!i.weights)continue;const r=[];for(let a=0;a<i.weights.length;a++){let l=i.biases&&i.biases[a]||0;for(let h=0;h<n.length;h++)l+=(i.weights[a][h]||0)*n[h];r.push(1/(1+Math.exp(-l)))}n=r,s<e.layers.length-1&&(this.lastHiddenActivations[s-1]=r)}}update(t){if(this.isDead||(this.updateSensors(t),this.checkCollisions(t),this.isDead))return;const e=this.sensorDistances.map(h=>h/this.sensorLength);this.lastInputs=e;const n=this.network.run(e);this.lastOutputs=n,this.calculateHiddenActivations(e);const s=n[0],i=n[1]*2-1;this.heading+=i*.1;const r=m.fromAngle(this.heading,s*this.maxForce);this.acc.add(r),this.vel.add(this.acc),this.vel.limit(this.maxSpeed),this.vel=this.vel.mult(.95);const a=new m(this.pos.x,this.pos.y);if(this.pos.add(this.vel),this.acc.mult(0),this.life--,this.life<=0){this.isDead=!0;return}this.checkCheckpoints(t,a),this.frameAge++,this.distanceTraveled+=this.vel.mag();const l=this.checkpointCount>0?this.checkpointCount/this.frameAge*1e4:0;this.fitness=this.checkpointCount*1e3+l}checkCheckpoints(t,e){const n=this.checkpointCount%t.checkpoints.length,s=t.checkpoints[n];$(e,this.pos,s[0],s[1])&&(this.checkpointCount++,this.life+=500,this.life>1e3&&(this.life=1e3))}updateSensors(t){this.sensorRays=[],this.sensorDistances=[];const e=[...t.innerWalls,...t.outerWalls];for(let n=0;n<this.sensorCount;n++){const s=this.heading+this.sensorAngles[n],i=m.fromAngle(s,this.sensorLength),r=new m(this.pos.x+i.x,this.pos.y+i.y);let a=null,l=this.sensorLength;for(const h of e){const d=$(this.pos,r,h[0],h[1]);if(d){const g=this.pos.dist(new m(d.x,d.y));g<l&&(l=g,a=new m(d.x,d.y))}}this.sensorDistances.push(l),a?this.sensorRays.push(a):this.sensorRays.push(r)}}checkCollisions(t){const e=[...t.innerWalls,...t.outerWalls],n=new m(this.pos.x+this.vel.x,this.pos.y+this.vel.y);for(const s of e)if($(this.pos,n,s[0],s[1])){this.isDead=!0;return}for(let s of this.sensorDistances)if(s<this.radius){this.isDead=!0;return}}draw(t,e=!1){if(!this.isDead){if(e){t.lineWidth=1;for(let n=0;n<this.sensorRays.length;n++){const s=this.sensorDistances[n]/this.sensorLength,i=Math.floor(255*(1-s)),r=Math.floor(255*s);t.strokeStyle=`rgba(${i}, ${r}, 0, 0.5)`,t.beginPath(),t.moveTo(this.pos.x,this.pos.y),t.lineTo(this.sensorRays[n].x,this.sensorRays[n].y),t.stroke()}}t.translate(this.pos.x,this.pos.y),t.rotate(this.heading),t.fillStyle=e?"#00ff00":"rgba(200, 200, 200, 0.5)",t.beginPath(),t.moveTo(this.radius,0),t.lineTo(-this.radius,-this.radius/1.5),t.lineTo(-this.radius,this.radius/1.5),t.closePath(),t.fill(),t.rotate(-this.heading),t.translate(-this.pos.x,-this.pos.y)}}}class A{populationSize=50;mutationRate=.1;boids=[];generation=1;timer=0;maxLifespan=2e3;eliteCount=1;tournamentSize=3;topParentsCount=5;lastGenEndStats=null;bestFitnessThisGen=0;lastImprovementTimer=0;bestBoidDiedAt=-1;constructor(t,e,n,s){this.populationSize=t;const i=localStorage.getItem("best_boid_brain"),r=localStorage.getItem("current_generation");r&&(this.generation=parseInt(r));for(let a=0;a<t;a++){const l=new _(e,n,s);if(i&&a===0)l.network.fromJSON(JSON.parse(i));else if(i&&a<t*.2){const h=JSON.parse(i);this.mutate(h,.2),l.network.fromJSON(h)}this.boids.push(l)}}update(t){this.timer++;let e=!0,n=0,s=0;for(const a of this.boids)a.update(t),a.isDead||(e=!1,a.fitness>s&&(s=a.fitness)),a.fitness>n&&(n=a.fitness);n>this.bestFitnessThisGen&&(this.bestFitnessThisGen=n,this.lastImprovementTimer=this.timer),this.bestFitnessThisGen>0&&(s>=this.bestFitnessThisGen?this.bestBoidDiedAt=-1:this.bestBoidDiedAt===-1&&(this.bestBoidDiedAt=this.timer));const i=this.maxLifespan-this.timer<=500&&this.timer-this.lastImprovementTimer>=500,r=this.bestBoidDiedAt!==-1&&this.timer-this.bestBoidDiedAt>=500;(e||this.timer>this.maxLifespan||i||r)&&(this.nextGeneration(t.startPoint.x,t.startPoint.y,t.startAngle),this.timer=0)}selectParent(){let t=null;for(let e=0;e<this.tournamentSize;e++){const n=Math.floor(Math.random()*this.boids.length),s=this.boids[n];(!t||s.fitness>t.fitness)&&(t=s)}return t}crossover(t,e){const n=JSON.parse(JSON.stringify(t));for(let s=0;s<n.layers.length;s++){const i=n.layers[s],r=e.layers[s];if(i.weights&&r?.weights)for(let a=0;a<i.weights.length;a++)for(let l=0;l<i.weights[a].length;l++){const h=Math.random();i.weights[a][l]=i.weights[a][l]*h+r.weights[a][l]*(1-h)}if(i.biases&&r?.biases)for(let a=0;a<i.biases.length;a++){const l=Math.random();i.biases[a]=i.biases[a]*l+r.biases[a]*(1-l)}}return n}nextGeneration(t,e,n){this.bestFitnessThisGen=0,this.lastImprovementTimer=0,this.bestBoidDiedAt=-1,this.lastGenEndStats={generation:this.generation,survivorCount:this.boids.filter(a=>!a.isDead).length,bestFitness:Math.max(...this.boids.map(a=>a.fitness)),diversity:this.calculateDiversity()},this.boids.sort((a,l)=>l.fitness-a.fitness);const s=[],i=this.boids[0];for(let a=0;a<this.eliteCount&&a<this.boids.length;a++){const l=new _(t,e,n);l.network.fromJSON(this.boids[a].network.toJSON()),s.push(l)}const r=Math.floor(this.populationSize*.2);for(let a=s.length;a<r;a++){const l=new _(t,e,n),h=i.network.toJSON();this.mutate(h,.2),l.network.fromJSON(h),s.push(l)}for(;s.length<this.populationSize;){const a=new _(t,e,n),l=this.selectParent(),h=this.selectParent(),d=l.network.toJSON(),g=h.network.toJSON(),f=this.crossover(d,g);this.mutate(f,this.mutationRate),a.network.fromJSON(f),s.push(a)}this.boids=s,this.generation++,localStorage.setItem("best_boid_brain",JSON.stringify(i.network.toJSON())),localStorage.setItem("current_generation",this.generation.toString())}mutate(t,e){for(let n=0;n<t.layers.length;n++){const s=t.layers[n];if(s.weights){for(let i=0;i<s.weights.length;i++)for(let r=0;r<s.weights[i].length;r++)Math.random()<e&&(s.weights[i][r]+=Math.random()*2-1);if(s.biases)for(let i=0;i<s.biases.length;i++)Math.random()<e&&(s.biases[i]+=Math.random()*2-1)}}}getBestActiveBoid(){let t=null,e=-1;for(let n of this.boids)n.fitness>e&&(e=n.fitness,t=n);return t}calculateDiversity(){if(this.boids.length<2)return 0;const t=Math.min(10,this.boids.length),e=[];for(let i=0;i<t;i++){const r=Math.floor(Math.random()*this.boids.length);e.push(this.boids[r].network.toJSON())}let n=0,s=0;for(let i=0;i<e.length;i++)for(let r=i+1;r<e.length;r++)n+=this.networkDistance(e[i],e[r]),s++;return s>0?n/s:0}networkDistance(t,e){let n=0;for(let s=0;s<t.layers.length;s++){const i=t.layers[s],r=e.layers[s];if(i.weights&&r.weights)for(let a=0;a<i.weights.length;a++)for(let l=0;l<i.weights[a].length;l++){const h=(i.weights[a][l]||0)-(r.weights[a]?.[l]||0);n+=h*h}if(i.biases&&r.biases)for(let a=0;a<i.biases.length;a++){const l=(i.biases[a]||0)-(r.biases[a]||0);n+=l*l}}return Math.sqrt(n)}}const c={ga:null,track:null,simulationCanvas:null,camera:{tx:0,ty:0,scale:1},populationSize:50,isFastTraining:!1,isPaused:!1,isEditingTrack:!1,trackDragIndex:-1,autoRandomizeTrack:!1,randomizeInterval:10,fitnessHistory:[],aliveHistory:[],diversityHistory:[],fps:0,frameCount:0,lastFpsTime:performance.now(),fitCamera:null};class yt{panels=new Map;zTop=200;register(t){const e=t.dataset.panelId;this.panels.set(e,t),this.wireDrag(t),this.wireMinimize(t),this.wireClose(t),this.wireFocus(t),this.restorePanelState(t)}wireDrag(t){const e=t.querySelector(".panel-header");if(!e)return;let n=0,s=0,i=0,r=0,a=!1;const l=d=>{if(!a)return;const g=d.clientX-n,f=d.clientY-s;t.style.left=`${Math.max(0,i+g)}px`,t.style.top=`${Math.max(0,r+f)}px`},h=()=>{a&&(a=!1,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",h),this.savePanelState(t))};e.addEventListener("mousedown",d=>{d.target.tagName!=="BUTTON"&&(a=!0,n=d.clientX,s=d.clientY,i=parseInt(t.style.left)||0,r=parseInt(t.style.top)||0,this.bringToFront(t),document.addEventListener("mousemove",l),document.addEventListener("mouseup",h),d.preventDefault())})}wireMinimize(t){const e=t.querySelector(".panel-btn-minimize");e&&e.addEventListener("click",()=>{const n=t.classList.toggle("panel--minimized");if(e.textContent=n?"‚ñ°":"‚àí",n)t.dataset.expandedHeight=String(t.offsetHeight),t.style.height="34px";else{const s=t.dataset.expandedHeight;t.style.height=s?`${s}px`:""}this.savePanelState(t)})}wireClose(t){const e=t.querySelector(".panel-btn-close");e&&e.addEventListener("click",()=>{this.setVisible(t,!1)})}wireFocus(t){t.addEventListener("mousedown",()=>this.bringToFront(t))}bringToFront(t){this.zTop++,t.style.zIndex=String(this.zTop)}setVisible(t,e){t.style.display=e?"flex":"none",this.savePanelState(t);const n=t.dataset.panelId,s=document.querySelector(`[data-toggle-panel="${n}"]`);s&&s.classList.toggle("toolbar-btn--active",e)}toggleVisible(t){const e=this.panels.get(t);if(!e)return;const n=e.style.display!=="none";this.setVisible(e,!n),n||this.bringToFront(e)}savePanelState(t){const e=t.dataset.panelId,n=t.classList.contains("panel--minimized"),s=n&&parseInt(t.dataset.expandedHeight||"0")||t.offsetHeight,i={left:parseInt(t.style.left)||0,top:parseInt(t.style.top)||0,width:t.offsetWidth,height:s,minimized:n,visible:t.style.display!=="none"};localStorage.setItem(`panel_state_${e}`,JSON.stringify(i))}restorePanelState(t){const e=t.dataset.panelId,n=localStorage.getItem(`panel_state_${e}`);if(n)try{const s=JSON.parse(n);if(t.style.left=`${s.left}px`,t.style.top=`${s.top}px`,t.style.width=`${s.width}px`,t.style.display=s.visible?"flex":"none",s.minimized){t.classList.add("panel--minimized"),t.dataset.expandedHeight=String(s.height),t.style.height="34px";const r=t.querySelector(".panel-btn-minimize");r&&(r.textContent="‚ñ°")}else t.style.height=`${s.height}px`;const i=document.querySelector(`[data-toggle-panel="${e}"]`);i&&i.classList.toggle("toolbar-btn--active",s.visible)}catch{}}saveAll(){this.panels.forEach(t=>this.savePanelState(t))}}function vt(o){const t=[];o.layers[1]?.weights?.[0]&&t.push(o.layers[1].weights[0].length);for(let e=1;e<o.layers.length;e++){const n=o.layers[e];n.biases&&t.push(n.biases.length)}return t}function bt(o,t){const e=t.network.toJSON();if(!e.layers||e.layers.length===0)return;const n=o.canvas.width,s=o.canvas.height,i=vt(e);if(i.length===0||n<10||s<10)return;const r=n/i.length,a=Math.max(1,Math.min(14,(s-100)/(Math.max(...i)*2.5))),l=[];for(let d=0;d<i.length;d++){const g=i[d],f=r*d+r/2,u=[],y=(s-80)/(g+1),v=50;for(let b=0;b<g;b++){const p=v+(b+1)*y;u.push({x:f,y:p})}l.push(u)}o.fillStyle="#aaa",o.font="11px Arial",o.textAlign="center";const h=["Input","Hidden 1","Hidden 2","Output"];for(let d=0;d<i.length;d++){const g=r*d+r/2;o.fillText(h[d]||"",g,20),o.fillStyle="#666",o.font="9px Arial",o.fillText(`(${i[d]} nodes)`,g,32),o.fillStyle="#aaa",o.font="11px Arial"}for(let d=1;d<i.length;d++){const g=i[d],f=i[d-1],u=e.layers[d];for(let y=0;y<g;y++){const v=l[d][y];for(let b=0;b<f;b++){const p=l[d-1][b];let C=0;u&&u.weights&&u.weights[y]&&(C=u.weights[y][b]||0);const q=Math.min(1,Math.abs(C)/3);q>.02&&(o.beginPath(),o.lineWidth=1+Math.abs(C)*.5,o.strokeStyle=C>0?`rgba(50, 255, 100, ${q})`:`rgba(255, 80, 80, ${q})`,o.moveTo(p.x,p.y),o.lineTo(v.x,v.y),o.stroke())}}}for(let d=0;d<l.length;d++)for(let g=0;g<l[d].length;g++){const f=l[d][g];let u=.5;if(d===0&&t.lastInputs[g]!==void 0)u=t.lastInputs[g];else if(d===l.length-1&&t.lastOutputs[g]!==void 0)u=t.lastOutputs[g];else if(d>0&&d<l.length-1){const p=d-1;t.lastHiddenActivations[p]?.[g]!==void 0&&(u=t.lastHiddenActivations[p][g])}u>.6?(o.shadowBlur=20,o.shadowColor=`rgba(0, 255, 200, ${u})`):u<.4&&(o.shadowBlur=10,o.shadowColor=`rgba(255, 100, 100, ${1-u})`),o.beginPath(),o.arc(f.x,f.y,a,0,Math.PI*2);let y,v,b;if(u<.5){const p=u*2;y=Math.floor(50*(1-p)+50*p),v=Math.floor(100*(1-p)+200*p),b=Math.floor(200*(1-p)+100*p)}else{const p=(u-.5)*2;y=Math.floor(50*(1-p)+255*p),v=Math.floor(200*(1-p)+200*p),b=Math.floor(100*(1-p)+50*p)}if(o.fillStyle=`rgb(${y}, ${v}, ${b})`,o.fill(),o.shadowBlur=0,o.strokeStyle="#fff",o.lineWidth=2,o.stroke(),o.fillStyle="#fff",o.font="bold 8px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText(u.toFixed(2),f.x,f.y),o.fillStyle="#888",o.font="8px Arial",o.textBaseline="top",d===0){const p=["L","FL","F","FR","R"];o.fillText(p[g]||`S${g+1}`,f.x,f.y+a+2)}else if(d===l.length-1){const p=["Thr","Str"];o.fillText(p[g]||`O${g+1}`,f.x,f.y+a+2)}}}function St(){const o=L("brain","üß† Brain Visualisation",360,420,20,60),t=document.createElement("canvas");return t.id="network-canvas",t.style.cssText="width:100%;height:100%;display:block;",o.querySelector(".panel-body").appendChild(t),new ResizeObserver(()=>{const n=o.querySelector(".panel-body");t.width=n.clientWidth,t.height=n.clientHeight}).observe(o.querySelector(".panel-body")),o}function xt(){const o=document.querySelector('[data-panel-id="brain"]');if(!o||o.style.display==="none"||o.classList.contains("panel--minimized"))return;const t=document.getElementById("network-canvas");if(!t||!c.ga)return;const e=t.getContext("2d");if(!e)return;const n=c.ga.getBestActiveBoid();e.fillStyle="#111318",e.fillRect(0,0,t.width,t.height),n&&bt(e,n)}function L(o,t,e,n,s,i){const r=document.createElement("div");return r.className="panel",r.dataset.panelId=o,r.style.cssText=`left:${s}px;top:${i}px;width:${e}px;height:${n}px;`,r.innerHTML=`
    <div class="panel-header">
      <span class="panel-title">${t}</span>
      <div class="panel-header-btns">
        <button class="panel-btn panel-btn-minimize" title="Minimise">‚àí</button>
        <button class="panel-btn panel-btn-close"    title="Close">‚úï</button>
      </div>
    </div>
    <div class="panel-body"></div>
  `,r}const E=220,kt=x.FIXED_SIZE,M=E/kt;function wt(){const o=E+16,t=E+16+34,e=L("minimap","üó∫ Minimap",o,t,20,500);e.style.resize="none";const n=e.querySelector(".panel-body");n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.padding="8px";const s=document.createElement("canvas");return s.id="minimap-canvas",s.width=E,s.height=E,s.style.cssText="border-radius:6px;background:#111;display:block;",n.appendChild(s),e}function It(){const o=document.querySelector('[data-panel-id="minimap"]');if(!o||o.style.display==="none"||o.classList.contains("panel--minimized"))return;const t=document.getElementById("minimap-canvas"),{ga:e,track:n,camera:s}=c;if(!t||!e||!n)return;const i=t.getContext("2d");if(!i)return;i.fillStyle="#0a0c10",i.fillRect(0,0,E,E),i.save(),i.setTransform(M,0,0,M,0,0),n.draw(i);const r=e.getBestActiveBoid();for(const b of e.boids)b.draw(i,b===r);i.restore();const a=window.innerWidth,l=window.innerHeight,{tx:h,ty:d,scale:g}=s,f=-h/g*M,u=-d/g*M,y=a/g*M,v=l/g*M;i.strokeStyle="rgba(99, 179, 255, 0.9)",i.lineWidth=1.5,i.strokeRect(f,u,y,v)}const R=200,w=[],I=[],P=[];let N=-1,Q=1,O=0,k=[];(function(){try{const t=localStorage.getItem("nnts_run_history");t&&(k=JSON.parse(t));const e=localStorage.getItem("nnts_chart_fitness"),n=localStorage.getItem("nnts_chart_alive"),s=localStorage.getItem("nnts_chart_diversity"),i=localStorage.getItem("nnts_chart_lastgen"),r=localStorage.getItem("nnts_chart_peak"),a=localStorage.getItem("nnts_chart_startgen");e&&w.push(...JSON.parse(e)),n&&I.push(...JSON.parse(n)),s&&P.push(...JSON.parse(s)),i&&(N=parseInt(i)),r&&(O=parseFloat(r)),a&&(Q=parseInt(a))}catch{}})();function Pt(){const o=L("chart","üìà Training Chart",360,380,window.innerWidth-380,60),t=o.querySelector(".panel-body"),e=document.createElement("div");e.className="chart-controls",e.innerHTML=`
    <label><input type="checkbox" id="chart-show-fitness"   checked> <span style="color:#4ade80">Fitness</span></label>
    <label><input type="checkbox" id="chart-show-alive"     checked> <span style="color:#60a5fa">Survivors</span></label>
    <label><input type="checkbox" id="chart-show-diversity" checked> <span style="color:#f97316">Diversity</span></label>
  `,t.appendChild(e);const n=document.createElement("canvas");n.id="chart-canvas",n.style.cssText="width:100%;display:block;",n.width=340,n.height=180,t.appendChild(n);const s=document.createElement("div");return s.id="chart-run-history",s.style.cssText=["overflow-y:auto","max-height:110px","font-size:0.70rem","color:#aaa","border-top:1px solid rgba(255,255,255,0.08)","padding-top:5px","margin-top:4px","flex-shrink:0"].join(";"),t.appendChild(s),new ResizeObserver(()=>{const r=o.querySelector(".panel-body");n.width=r.clientWidth,n.height=Math.max(80,r.clientHeight-(e.offsetHeight||28)-(s.offsetHeight||120))}).observe(t),o}function J(o){if(w.length===0&&!o.lastGenEndStats)return;const t=o.lastGenEndStats,e=w[w.length-1]??0,n=I[I.length-1]??0,s=P[P.length-1]??0,i={runId:(k[k.length-1]?.runId??0)+1,genCount:(t?.generation??o.generation)-Q,peakFitness:O||e,finalSurvivorCount:t?t.survivorCount:Math.round(n/100*c.populationSize),finalSurvivorPct:n,finalDiversity:t?t.diversity:s,timestamp:Date.now()};k.push(i),k.length>50&&k.shift(),localStorage.setItem("nnts_run_history",JSON.stringify(k))}function H(){w.length=0,I.length=0,P.length=0,N=-1,O=0,localStorage.removeItem("nnts_chart_fitness"),localStorage.removeItem("nnts_chart_alive"),localStorage.removeItem("nnts_chart_diversity"),localStorage.removeItem("nnts_chart_lastgen"),localStorage.removeItem("nnts_chart_peak"),localStorage.removeItem("nnts_chart_startgen")}function j(o){Q=o,localStorage.setItem("nnts_chart_startgen",String(o))}function et(){k.length=0,localStorage.removeItem("nnts_run_history")}function Ct(){const{ga:o}=c;if(!o)return;const t=o.lastGenEndStats;if(!t||t.generation===N)return;N=t.generation;const e=t.bestFitness,n=t.survivorCount/c.populationSize*100,s=t.diversity;O=Math.max(O,e),w.push(e),I.push(n),P.push(s),w.length>R&&w.shift(),I.length>R&&I.shift(),P.length>R&&P.shift(),localStorage.setItem("nnts_chart_fitness",JSON.stringify(w)),localStorage.setItem("nnts_chart_alive",JSON.stringify(I)),localStorage.setItem("nnts_chart_diversity",JSON.stringify(P)),localStorage.setItem("nnts_chart_lastgen",String(N)),localStorage.setItem("nnts_chart_peak",String(O))}function Et(){const o=document.querySelector('[data-panel-id="chart"]');if(!o||o.style.display==="none"||o.classList.contains("panel--minimized"))return;const t=document.getElementById("chart-canvas");if(!t)return;const e=t.getContext("2d");if(!e)return;const n=t.width,s=t.height;e.fillStyle="#0d0f14",e.fillRect(0,0,n,s),e.strokeStyle="rgba(255,255,255,0.06)",e.lineWidth=1;for(let d=0;d<=4;d++){const g=s*(d/4);e.beginPath(),e.moveTo(0,g),e.lineTo(n,g),e.stroke()}const i=document.getElementById("chart-show-fitness")?.checked??!0,r=document.getElementById("chart-show-alive")?.checked??!0,a=document.getElementById("chart-show-diversity")?.checked??!0;G(e,w,"#4ade80",n,s,i),G(e,I,"#60a5fa",n,s,r,0,100),G(e,P,"#f97316",n,s,a),e.fillStyle="#555",e.font="10px Inter,sans-serif",e.textAlign="right",e.fillText(`gen ${c.ga?.generation??0}`,n-4,s-4);const l=document.getElementById("chart-run-history");if(!l)return;if(k.length===0){l.innerHTML='<span style="color:#444;font-size:0.68rem;">No completed runs yet.</span>';return}const h=[...k].reverse().map(d=>{const g=new Date(d.timestamp),f=y=>String(y).padStart(2,"0"),u=`${g.getMonth()+1}/${g.getDate()} ${g.getHours()}:${f(g.getMinutes())}`;return`<tr>
          <td style="padding:1px 4px;color:#888">#${d.runId}</td>
          <td style="padding:1px 4px">${d.genCount}</td>
          <td style="padding:1px 4px;color:#4ade80">${Math.floor(d.peakFitness).toLocaleString()}</td>
          <td style="padding:1px 4px;color:#60a5fa">${Math.round(d.finalSurvivorPct)}%</td>
          <td style="padding:1px 4px;color:#f97316">${d.finalDiversity.toFixed(2)}</td>
          <td style="padding:1px 4px;color:#555">${u}</td>
        </tr>`}).join("");l.innerHTML=`<table style="width:100%;border-collapse:collapse;line-height:1.4;">
      <thead><tr style="color:#444;border-bottom:1px solid rgba(255,255,255,0.06);">
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Run</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Gens</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Peak</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Surv</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Div</th>
        <th style="padding:1px 4px;font-weight:normal;text-align:left">Date</th>
      </tr></thead>
      <tbody>${h}</tbody>
    </table>`}function G(o,t,e,n,s,i,r,a){if(!i||t.length<2)return;const l=r??Math.min(...t),d=(a??Math.max(...t))-l||1;o.beginPath(),o.strokeStyle=e,o.lineWidth=1.5,o.shadowColor=e,o.shadowBlur=4;for(let g=0;g<t.length;g++){const f=g/(t.length-1)*n,u=s-(t[g]-l)/d*(s-4)-2;g===0?o.moveTo(f,u):o.lineTo(f,u)}o.stroke(),o.shadowBlur=0}function Tt(){const o=L("config","‚öôÔ∏è Config",300,400,window.innerWidth-325,330),t=o.querySelector(".panel-body");t.style.overflowY="auto",t.style.padding="10px 14px",t.innerHTML=`
    <div class="cfg-section">
      <div class="cfg-label">Population Size</div>
      <div class="cfg-row">
        <input type="range" id="cfg-pop-size" min="10" max="200" step="5" value="${c.populationSize}">
        <span class="cfg-value" id="cfg-pop-size-val">${c.populationSize}</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Mutation Rate</div>
      <div class="cfg-row">
        <input type="range" id="cfg-mutation" min="0.01" max="0.5" step="0.01" value="0.1">
        <span class="cfg-value" id="cfg-mutation-val">0.10</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Tournament Size</div>
      <div class="cfg-row">
        <input type="range" id="cfg-tournament" min="2" max="10" step="1" value="3">
        <span class="cfg-value" id="cfg-tournament-val">3</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Elite Count</div>
      <div class="cfg-row">
        <input type="range" id="cfg-elite" min="1" max="10" step="1" value="1">
        <span class="cfg-value" id="cfg-elite-val">1</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Max Lifespan (frames)</div>
      <div class="cfg-row">
        <input type="range" id="cfg-lifespan" min="200" max="5000" step="100" value="2000">
        <span class="cfg-value" id="cfg-lifespan-val">2000</span>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-label">Track Options</div>
      <div class="cfg-row-v">
        <button id="cfg-btn-randomize">üîÄ Randomize Track</button>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
          <input type="checkbox" id="cfg-auto-randomize">
          <label for="cfg-auto-randomize" style="font-size:0.85rem;">Auto-randomize every</label>
          <input type="number" id="cfg-auto-gens" min="1" max="100" value="${c.randomizeInterval}"
                 style="width:46px;background:#1a1a2e;border:1px solid #333;color:#ddd;border-radius:4px;padding:2px 4px;font-size:0.85rem;">
          <span style="font-size:0.85rem;">gen</span>
        </div>
        <div style="margin-top:6px;font-size:0.8rem;color:#666;">
          Seed: <span id="cfg-track-seed">Default</span>
        </div>
      </div>
    </div>

    <div class="cfg-section">
      <button id="cfg-btn-fast" class="cfg-btn-danger">‚ö° Toggle Fast Training</button>
    </div>
  `,D(t,"cfg-pop-size","cfg-pop-size-val",s=>{c.populationSize=s}),D(t,"cfg-mutation","cfg-mutation-val",s=>{c.ga&&(c.ga.mutationRate=s)},2),D(t,"cfg-tournament","cfg-tournament-val",s=>{if(!c.ga)return;const i=Math.min(s,c.populationSize-1);if(c.ga.tournamentSize=i,i!==s){const r=t.querySelector("#cfg-tournament"),a=t.querySelector("#cfg-tournament-val");r&&(r.value=String(i)),a&&(a.textContent=String(i))}}),D(t,"cfg-elite","cfg-elite-val",s=>{if(!c.ga)return;const i=Math.min(s,c.populationSize-2);if(c.ga.eliteCount=i,i!==s){const r=t.querySelector("#cfg-elite"),a=t.querySelector("#cfg-elite-val");r&&(r.value=String(i)),a&&(a.textContent=String(i))}}),D(t,"cfg-lifespan","cfg-lifespan-val",s=>{c.ga&&(c.ga.maxLifespan=s)}),t.querySelector("#cfg-btn-randomize")?.addEventListener("click",()=>{if(!c.track||!c.ga)return;const s=c.track.randomize(1200,1200),i=document.getElementById("cfg-track-seed");i&&(i.textContent=String(s)),B()});const e=t.querySelector("#cfg-auto-randomize");e?.addEventListener("change",()=>{c.autoRandomizeTrack=e.checked}),t.querySelector("#cfg-auto-gens")?.addEventListener("change",s=>{const i=parseInt(s.target.value);!isNaN(i)&&i>0&&(c.randomizeInterval=i)});const n=t.querySelector("#cfg-btn-fast");return n?.addEventListener("click",()=>{c.isFastTraining=!c.isFastTraining,n.textContent=c.isFastTraining?"üê¢ Toggle Normal Viz":"‚ö° Toggle Fast Training"}),o}function Lt(){const o=document.querySelector('[data-panel-id="config"]');if(!o||o.style.display==="none")return;const t=document.getElementById("cfg-track-seed");t&&c.track&&(t.textContent=c.track.seed===0?"Default":String(c.track.seed))}function D(o,t,e,n,s=0){const i=o.querySelector(`#${t}`),r=o.querySelector(`#${e}`);!i||!r||i.addEventListener("input",()=>{const a=parseFloat(i.value);r.textContent=a.toFixed(s),n(a)})}function B(){const{ga:o,track:t}=c;if(!(!o||!t)){for(const e of o.boids)e.pos.x=t.startPoint.x,e.pos.y=t.startPoint.y,e.heading=t.startAngle,e.isDead=!1,e.fitness=0,e.distanceTraveled=0,e.checkpointCount=0,e.life=500;o.timer=0}}function Mt(){const o=L("saveload","üíæ Save / Load",280,310,window.innerWidth-305,window.innerHeight-330),t=o.querySelector(".panel-body");return t.style.padding="12px 14px",t.style.gap="8px",t.style.display="flex",t.style.flexDirection="column",t.innerHTML=`
    <div class="sl-section">
      <div class="sl-title">Brain</div>
      <button id="sl-btn-export">‚¨á Export Best Brain (.json)</button>
      <button id="sl-btn-import">‚¨Ü Import Brain (.json)</button>
    </div>
    <div class="sl-section">
      <div class="sl-title">Session</div>
      <button id="sl-btn-save-session">üì¶ Save Session</button>
      <button id="sl-btn-load-session">üìÇ Load Session</button>
    </div>
    <div class="sl-section">
      <div class="sl-title">Generation</div>
      <button id="sl-btn-restart">‚Ü© Restart Generation</button>
      <button id="sl-btn-load-preset">üß¨ New Sim from brain1.json</button>
      <button id="sl-btn-clear" class="sl-btn-danger">üóë Clear History</button>
    </div>
    <div id="sl-status" style="font-size:0.78rem;color:#888;min-height:18px;"></div>
  `,t.querySelector("#sl-btn-export")?.addEventListener("click",Ot),t.querySelector("#sl-btn-import")?.addEventListener("click",Dt),t.querySelector("#sl-btn-save-session")?.addEventListener("click",Ft),t.querySelector("#sl-btn-load-session")?.addEventListener("click",zt),t.querySelector("#sl-btn-restart")?.addEventListener("click",()=>{const{ga:e,track:n}=c;!e||!n||(J(e),H(),c.ga=new A(c.populationSize,n.startPoint.x,n.startPoint.y,n.startAngle),c.ga.generation=1,j(1),S("Generation restarted."))}),t.querySelector("#sl-btn-load-preset")?.addEventListener("click",()=>{if(!confirm("Start a completely new simulation seeded from brain1.json?"))return;const{ga:e,track:n}=c;e&&J(e),et(),H(),localStorage.removeItem("best_boid_brain"),localStorage.removeItem("current_generation"),n&&fetch("./brain1.json").then(s=>s.json()).then(s=>{if(!s.network){S("‚ùå brain1.json missing network");return}c.ga=new A(c.populationSize,n.startPoint.x,n.startPoint.y,n.startAngle),c.ga.generation=1,j(1),c.ga.boids[0].network.fromJSON(s.network),localStorage.setItem("best_boid_brain",JSON.stringify(s.network)),S("‚úÖ New sim started from brain1.json")}).catch(()=>S("‚ùå Could not load brain1.json"))}),t.querySelector("#sl-btn-clear")?.addEventListener("click",()=>{if(!confirm("Clear all training history? This will reset the brain."))return;const{ga:e,track:n}=c;e&&J(e),et(),H(),localStorage.removeItem("best_boid_brain"),localStorage.removeItem("current_generation"),n&&(c.ga=new A(c.populationSize,n.startPoint.x,n.startPoint.y,n.startAngle),c.ga.generation=1,j(1),S("History cleared."))}),o}function S(o){const t=document.getElementById("sl-status");t&&(t.textContent=o,setTimeout(()=>{t&&(t.textContent="")},3e3))}function Ot(){const{ga:o}=c;if(!o)return;const t=o.boids.reduce((n,s)=>s.fitness>n.fitness?s:n,o.boids[0]);if(!t)return;const e={generation:o.generation,fitness:t.fitness,network:t.network.toJSON(),exportedAt:new Date().toISOString()};gt(e,`brain-gen${o.generation}-fit${Math.floor(t.fitness)}.json`),S(`Exported gen ${o.generation}.`)}function Dt(){ut(".json",async o=>{try{const t=JSON.parse(await o.text());if(!t.network?.layers){S("‚ùå Invalid brain file");return}const{ga:e}=c;if(!e)return;e.boids[0].network.fromJSON(t.network),localStorage.setItem("best_boid_brain",JSON.stringify(t.network)),t.generation&&(e.generation=t.generation,localStorage.setItem("current_generation",String(t.generation))),S(`‚úÖ Brain imported (gen ${t.generation??"?"}, fit ${Math.floor(t.fitness??0)})`)}catch(t){S(`‚ùå ${t.message}`)}})}function Ft(){const{ga:o,track:t}=c;if(!o||!t)return;const e=o.getBestActiveBoid(),n={generation:o.generation,trackSeed:t.seed,bestBrainJSON:e?e.network.toJSON():null,savedAt:new Date().toISOString()};gt(n,`session-gen${o.generation}-${Date.now()}.json`),S("Session saved.")}function zt(){ut(".json",async o=>{try{const t=JSON.parse(await o.text()),{ga:e}=c;if(!e)return;t.generation&&(e.generation=t.generation),t.bestBrainJSON&&(e.boids[0].network.fromJSON(t.bestBrainJSON),localStorage.setItem("best_boid_brain",JSON.stringify(t.bestBrainJSON))),t.trackSeed&&c.track&&c.track.generateSimpleLoopedTrack(1200,1200,t.trackSeed),S(`‚úÖ Session loaded (gen ${t.generation??"?"})`)}catch(t){S(`‚ùå ${t.message}`)}})}function gt(o,t){const e=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),s=document.createElement("a");s.href=n,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function ut(o,t){const e=document.createElement("input");e.type="file",e.accept=o,e.onchange=n=>{const s=n.target.files?.[0];s&&t(s)},e.click()}const nt=200;let U=[];function Nt(){const o=L("debug","üêõ Debug",320,380,390,60),t=o.querySelector(".panel-body");return t.style.display="flex",t.style.flexDirection="column",t.style.padding="10px 12px",t.style.gap="6px",t.innerHTML=`
    <div class="dbg-stats">
      <div class="dbg-row"><span>FPS</span><span id="dbg-fps">‚Äî</span></div>
      <div class="dbg-row"><span>Generation</span><span id="dbg-gen">‚Äî</span></div>
      <div class="dbg-row"><span>Frames Left</span><span id="dbg-frames">‚Äî</span></div>
      <div class="dbg-row"><span>Alive</span><span id="dbg-alive">‚Äî</span></div>
      <div class="dbg-row"><span>Best Boid TTL</span><span id="dbg-best-ttl">‚Äî</span></div>
      <div class="dbg-row"><span>Best Fitness</span><span id="dbg-fitness">‚Äî</span></div>
      <div class="dbg-row"><span>Diversity</span><span id="dbg-diversity">‚Äî</span></div>
    </div>
    <div class="dbg-section-title">Best Boid I/O</div>
    <div class="dbg-stats" id="dbg-io"></div>
    <div class="dbg-section-title" style="display:flex;justify-content:space-between;">
      Console Log <button id="dbg-clear-log" style="font-size:0.75rem;padding:1px 6px;">Clear</button>
    </div>
    <textarea id="dbg-log" readonly style="flex:1;resize:none;background:#0a0c10;border:1px solid #222;border-radius:6px;color:#8be;font-family:monospace;font-size:0.72rem;padding:6px;overflow-y:auto;"></textarea>
  `,t.querySelector("#dbg-clear-log")?.addEventListener("click",()=>{U=[];const e=document.getElementById("dbg-log");e&&(e.value="")}),o}function Bt(){const o=document.querySelector('[data-panel-id="debug"]');if(!o||o.style.display==="none")return;const{ga:t,fps:e}=c;if(!t)return;F("dbg-fps",e.toFixed(1)),F("dbg-gen",String(t.generation)),F("dbg-frames",String(Math.max(0,t.maxLifespan-t.timer)));const n=t.boids.filter(a=>!a.isDead).length;F("dbg-alive",`${n} / ${c.populationSize}`);const s=t.getBestActiveBoid();F("dbg-fitness",s?Math.floor(s.fitness).toString():"‚Äî");const i=document.getElementById("dbg-best-ttl");if(i)if(t.bestBoidDiedAt===-1)i.textContent="500",i.style.color="#4ade80";else{const a=Math.max(0,500-(t.timer-t.bestBoidDiedAt));i.textContent=String(a),i.style.color=a>250?"#fb923c":"#f87171"}if(t.timer%15===0){const a=t.calculateDiversity(),l=document.getElementById("dbg-diversity");l&&(l.textContent=a.toFixed(2),l.style.color=a<1?"#f87171":a<3?"#fb923c":"#4ade80")}const r=document.getElementById("dbg-io");if(r&&s){const a=["L","FL","F","FR","R"],l=["Thr","Str"];let h="";s.lastInputs.forEach((d,g)=>{h+=`<div class="dbg-row"><span>In[${a[g]||g}]</span><span>${d.toFixed(3)}</span></div>`}),s.lastOutputs.forEach((d,g)=>{h+=`<div class="dbg-row"><span>Out[${l[g]||g}]</span><span>${d.toFixed(3)}</span></div>`}),r.innerHTML=h}if(U.length){const a=document.getElementById("dbg-log");if(a){const l=U.splice(0);a.value+=l.join(`
`)+`
`;const h=a.value.split(`
`);h.length>nt&&(a.value=h.slice(-nt).join(`
`)),a.scrollTop=a.scrollHeight}}}function F(o,t){const e=document.getElementById(o);e&&(e.textContent=t)}function _t(){const o=L("track","üõ£ Track",300,500,20,Math.max(60,window.innerHeight-530)),t=o.querySelector(".panel-body");t.style.overflowY="auto",t.style.padding="10px 14px",t.innerHTML=`
    <div class="cfg-section">
      <div class="cfg-label">Track Width</div>
      <div class="cfg-row">
        <input type="range" id="trk-width" min="80" max="240" step="5" value="120">
        <span class="cfg-value" id="trk-width-val">120</span>
      </div>
    </div>
    <div class="cfg-section">
      <div class="cfg-label">Control Points</div>
      <div class="cfg-row">
        <input type="range" id="trk-cp" min="6" max="22" step="1" value="14">
        <span class="cfg-value" id="trk-cp-val">14</span>
      </div>
    </div>
    <div class="cfg-section">
      <div class="cfg-label">Radius Variance <span style="color:#555;font-size:0.75rem">Oval ‚Üê ‚Üí Diverse</span></div>
      <div class="cfg-row">
        <input type="range" id="trk-variance" min="0" max="0.8" step="0.05" value="0.35">
        <span class="cfg-value" id="trk-variance-val">0.35</span>
      </div>
    </div>
    <div class="cfg-section">
      <div class="cfg-label">Corner Tightness <span style="color:#555;font-size:0.75rem">Gentle ‚Üê ‚Üí Sharp</span></div>
      <div class="cfg-row">
        <input type="range" id="trk-corners" min="0" max="0.5" step="0.05" value="0.20">
        <span class="cfg-value" id="trk-corners-val">0.20</span>
      </div>
    </div>
    <div class="cfg-section">
      <div class="cfg-label">Smoothness</div>
      <div class="cfg-row">
        <input type="range" id="trk-smooth" min="6" max="30" step="1" value="15">
        <span class="cfg-value" id="trk-smooth-val">15</span>
      </div>
    </div>
    <div class="cfg-section">
      <div class="cfg-row-v" style="gap:6px;">
        <div style="display:flex;gap:6px;align-items:center;">
          <button id="trk-btn-generate" style="flex:1;">üîÄ Generate</button>
          <input type="number" id="trk-seed" placeholder="Seed" min="1"
            style="width:70px;background:#1a1a2e;border:1px solid #333;color:#ddd;border-radius:4px;padding:3px 6px;font-size:0.82rem;">
        </div>
        <div style="display:flex;gap:5px;margin-top:2px;">
          <button id="trk-preset-oval"  class="trk-preset-btn">üîµ Oval</button>
          <button id="trk-preset-tech"  class="trk-preset-btn">‚öôÔ∏è Technical</button>
          <button id="trk-preset-f1"    class="trk-preset-btn">üèé F1</button>
        </div>
      </div>
    </div>

    <div class="cfg-section" style="border-top:1px solid #222;padding-top:8px;margin-top:4px;">
      <div class="cfg-label">Edit Mode</div>
      <div class="cfg-row-v" style="gap:6px;">
        <button id="trk-btn-edit">‚úèÔ∏è Enter Edit Mode</button>
        <button id="trk-btn-exit-edit" style="display:none;">‚úÖ Exit &amp; Apply</button>
        <div id="trk-edit-hint" style="display:none;font-size:0.75rem;color:#888;line-height:1.4;">
          Drag the numbered dots to reshape the track. Track updates live.
        </div>
      </div>
    </div>

    <div class="cfg-section" style="border-top:1px solid #222;padding-top:8px;margin-top:4px;">
      <div class="cfg-label">Files</div>
      <div class="cfg-row-v" style="gap:6px;">
        <button id="trk-btn-export">‚¨á Export Track (.json)</button>
        <button id="trk-btn-import">‚¨Ü Import Track (.json)</button>
      </div>
    </div>
  `,z(t,"trk-width","trk-width-val",i=>{c.track&&(c.track.trackWidth=i)}),z(t,"trk-cp","trk-cp-val",i=>{c.track&&(c.track.numControlPoints=i)}),z(t,"trk-variance","trk-variance-val",i=>{c.track&&(c.track.radiusVariance=i)},2),z(t,"trk-corners","trk-corners-val",i=>{c.track&&(c.track.cornerTightness=i)},2),z(t,"trk-smooth","trk-smooth-val",i=>{c.track&&(c.track.segmentsPerCurve=i)}),t.querySelector("#trk-btn-generate")?.addEventListener("click",()=>{const{track:i}=c;if(!i)return;const r=t.querySelector("#trk-seed"),a=parseInt(r.value),l=isNaN(a)||a<1?0:a,h=i.randomize(1200,1200);l>0?(i.generateSimpleLoopedTrack(1200,1200,l),r.value=String(l)):r.value=String(h),B()}),t.querySelector("#trk-preset-oval")?.addEventListener("click",()=>{V(t,{numControlPoints:8,radiusVariance:.05,cornerTightness:.05,trackWidth:150,segmentsPerCurve:15})}),t.querySelector("#trk-preset-tech")?.addEventListener("click",()=>{V(t,{numControlPoints:16,radiusVariance:.45,cornerTightness:.35,trackWidth:100,segmentsPerCurve:18})}),t.querySelector("#trk-preset-f1")?.addEventListener("click",()=>{V(t,{numControlPoints:14,radiusVariance:.55,cornerTightness:.25,trackWidth:110,segmentsPerCurve:18})});const e=t.querySelector("#trk-btn-edit"),n=t.querySelector("#trk-btn-exit-edit"),s=t.querySelector("#trk-edit-hint");return e.addEventListener("click",()=>{c.isEditingTrack=!0,c.isFastTraining=!1,c.isPaused=!0,c.fitCamera?.(),e.style.display="none",n.style.display="",s.style.display=""}),n.addEventListener("click",()=>{c.isEditingTrack=!1,c.trackDragIndex=-1,c.isPaused=!1,n.style.display="none",s.style.display="none",e.style.display="",B()}),t.querySelector("#trk-btn-export")?.addEventListener("click",()=>{const{track:i}=c;if(!i||i.controlPoints.length===0)return;const r={controlPoints:i.controlPoints.map(d=>({x:d.x,y:d.y})),trackWidth:i.trackWidth,numControlPoints:i.numControlPoints,segmentsPerCurve:i.segmentsPerCurve,radiusVariance:i.radiusVariance,cornerTightness:i.cornerTightness},a=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),l=URL.createObjectURL(a),h=document.createElement("a");h.href=l,h.download=`track-${Date.now()}.json`,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(l)}),t.querySelector("#trk-btn-import")?.addEventListener("click",()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=()=>{const r=i.files?.[0];r&&r.text().then(a=>{try{const l=JSON.parse(a),{track:h}=c;if(!h||!Array.isArray(l.controlPoints))return;h.controlPoints=l.controlPoints.map(d=>new m(d.x,d.y)),l.trackWidth&&(h.trackWidth=l.trackWidth),l.numControlPoints&&(h.numControlPoints=l.numControlPoints),l.segmentsPerCurve&&(h.segmentsPerCurve=l.segmentsPerCurve),l.radiusVariance!==void 0&&(h.radiusVariance=l.radiusVariance),l.cornerTightness!==void 0&&(h.cornerTightness=l.cornerTightness),ft(t,h),h.regenerateFromControlPoints(),B()}catch{}})},i.click()}),o}function Wt(){const o=document.querySelector('[data-panel-id="track"]');if(!o||o.style.display==="none")return;const t=o.querySelector("#trk-btn-edit"),e=o.querySelector("#trk-btn-exit-edit"),n=o.querySelector("#trk-edit-hint");if(t&&e&&n){const s=c.isEditingTrack;t.style.display=s?"none":"",e.style.display=s?"":"none",n.style.display=s?"":"none"}}function z(o,t,e,n,s=0){const i=o.querySelector(`#${t}`),r=o.querySelector(`#${e}`);!i||!r||i.addEventListener("input",()=>{const a=parseFloat(i.value);r.textContent=a.toFixed(s),n(a)})}function V(o,t){const{track:e}=c;if(!e)return;e.numControlPoints=t.numControlPoints,e.radiusVariance=t.radiusVariance,e.cornerTightness=t.cornerTightness,e.trackWidth=t.trackWidth,e.segmentsPerCurve=t.segmentsPerCurve,ft(o,e),e.randomize(1200,1200);const n=o.querySelector("#trk-seed");n&&(n.value=String(e.seed)),B()}function ft(o,t){const e=(n,s,i,r=0)=>{const a=o.querySelector(`#${n}`),l=o.querySelector(`#${s}`);a&&(a.value=String(i)),l&&(l.textContent=i.toFixed(r))};e("trk-width","trk-width-val",t.trackWidth),e("trk-cp","trk-cp-val",t.numControlPoints),e("trk-variance","trk-variance-val",t.radiusVariance,2),e("trk-corners","trk-corners-val",t.cornerTightness,2),e("trk-smooth","trk-smooth-val",t.segmentsPerCurve)}let X;const st=50,T=x.FIXED_SIZE,At=46,it=1.25,ot=.07;function at(){const o=c.simulationCanvas;o&&(o.width=window.innerWidth,o.height=window.innerHeight-At)}function qt(o){const{tx:t,ty:e,scale:n}=c.camera;o.setTransform(n,0,0,n,t,e)}function K(o){o.setTransform(1,0,0,1,0,0)}function W(){const o=c.simulationCanvas;if(!o)return;const t=o.width,e=o.height,n=Math.min(t,e)/T*.9;c.camera.scale=n,c.camera.tx=(t-T*n)/2,c.camera.ty=(e-T*n)/2,pt()}function rt(o){const t=c.simulationCanvas;if(!t)return;const{tx:e,ty:n,scale:s}=c.camera,i=t.width/2,r=t.height/2,a=Math.min(8,Math.max(.1,s*o));c.camera.tx=i-(i-e)*(a/s),c.camera.ty=r-(r-n)*(a/s),c.camera.scale=a,pt()}function $t(){const{ga:o,simulationCanvas:t,camera:e}=c;if(!o||!t)return;const n=o.getBestActiveBoid();if(!n)return;const{scale:s}=e,i=t.width/2-n.pos.x*s,r=t.height/2-n.pos.y*s;e.tx+=(i-e.tx)*ot,e.ty+=(r-e.ty)*ot}function Rt(){["brain","minimap","chart","config","saveload","debug","track"].forEach(o=>{localStorage.removeItem(`panel_state_${o}`)}),location.reload()}function lt(){const o=document.getElementById("simulation-canvas");c.simulationCanvas=o,at(),window.addEventListener("resize",()=>{at(),W()}),W(),c.fitCamera=W;const t=new x(T,T),e=new A(st,t.startPoint.x,t.startPoint.y,t.startAngle);c.track=t,c.ga=e,c.populationSize=st,X=new yt;const n=document.getElementById("panel-layer");[St(),wt(),Pt(),Tt(),Mt(),Nt(),_t()].forEach(a=>{n.appendChild(a),X.register(a)}),document.querySelectorAll("[data-toggle-panel]").forEach(a=>{const l=a.dataset.togglePanel;a.addEventListener("click",()=>X.toggleVisible(l))}),document.getElementById("btn-zoom-in")?.addEventListener("click",()=>rt(it)),document.getElementById("btn-zoom-out")?.addEventListener("click",()=>rt(1/it)),document.getElementById("btn-zoom-reset")?.addEventListener("click",W),document.getElementById("btn-reset-panels")?.addEventListener("click",Rt);const i=document.getElementById("btn-pause");i?.addEventListener("click",()=>{c.isPaused=!c.isPaused,i&&(i.textContent=c.isPaused?"‚ñ∂ Resume":"‚è∏ Pause",i.classList.toggle("toolbar-btn--active",c.isPaused))}),o.addEventListener("contextmenu",a=>a.preventDefault());const r=18;o.addEventListener("mousedown",a=>{if(!c.isEditingTrack||!c.track)return;const l=o.getBoundingClientRect(),{tx:h,ty:d,scale:g}=c.camera,f=(a.clientX-l.left-h)/g,u=(a.clientY-l.top-d)/g,y=c.track.controlPoints;for(let v=0;v<y.length;v++){const b=y[v].x-f,p=y[v].y-u;if(Math.sqrt(b*b+p*p)<r){c.trackDragIndex=v;break}}}),o.addEventListener("mousemove",a=>{if(!c.isEditingTrack||c.trackDragIndex===-1||!c.track)return;const l=o.getBoundingClientRect(),{tx:h,ty:d,scale:g}=c.camera;c.track.controlPoints[c.trackDragIndex].x=(a.clientX-l.left-h)/g,c.track.controlPoints[c.trackDragIndex].y=(a.clientY-l.top-d)/g,c.track.regenerateFromControlPoints()}),o.addEventListener("mouseup",()=>{c.trackDragIndex=-1}),o.addEventListener("mouseleave",()=>{c.trackDragIndex=-1}),requestAnimationFrame(mt)}function pt(){const o=Math.round(c.camera.scale*100),t=document.getElementById("toolbar-zoom");t&&(t.textContent=`${o}%`)}let ct=0;function dt(){const{ga:o,track:t}=c;!o||!t||(ct=o.generation,o.update(t),c.autoRandomizeTrack&&o.generation>ct&&o.generation%c.randomizeInterval===0&&t.randomize(T,T))}function Z(){const o=c.simulationCanvas,{ga:t,track:e}=c;if(!o||!t||!e)return;const n=o.getContext("2d");if(K(n),n.fillStyle="#0a0c10",n.fillRect(0,0,o.width,o.height),qt(n),e.draw(n),!c.isEditingTrack){const s=t.getBestActiveBoid();for(const i of t.boids)i.draw(n,i===s)}c.isEditingTrack&&e.drawEditOverlay(n,c.trackDragIndex),K(n)}let ht=performance.now(),Y=0;function Jt(o){Y++;const t=o-ht;t>=500&&(c.fps=Y/t*1e3,Y=0,ht=o)}function mt(o){if(Jt(o),c.isEditingTrack)Z();else if(c.isPaused)Z();else if(c.isFastTraining){for(let n=0;n<20;n++)dt();const t=c.simulationCanvas,{ga:e}=c;if(t&&e){const n=t.getContext("2d");K(n),n.fillStyle="#0a0c10",n.fillRect(0,0,t.width,t.height),n.fillStyle="rgba(99,102,241,0.8)",n.font="bold 48px Inter,sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(`‚ö° FAST TRAINING ‚Äî GEN ${e.generation}`,t.width/2,t.height/2)}}else $t(),dt(),Z();Ct(),xt(),It(),Et(),Lt(),Wt(),Bt(),requestAnimationFrame(mt)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",lt):lt();
