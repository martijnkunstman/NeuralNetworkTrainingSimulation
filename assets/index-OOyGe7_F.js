(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class f{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}mult(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}limit(t){if(this.mag()>t){const e=this.getNormalized();this.x=e.x*t,this.y=e.y*t}return this}getNormalized(){const t=this.mag();return t!==0?new f(this.x/t,this.y/t):new f(0,0)}heading(){return Math.atan2(this.y,this.x)}rotate(t){const e=this.heading()+t,s=this.mag();return new f(Math.cos(e)*s,Math.sin(e)*s)}dist(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}copy(){return new f(this.x,this.y)}static fromAngle(t,e=1){return new f(Math.cos(t)*e,Math.sin(t)*e)}}class R{innerWalls=[];outerWalls=[];checkpoints=[];startPoint=new f(0,0);startAngle=0;constructor(t,e){this.generateSimpleLoopedTrack(t,e)}generateSimpleLoopedTrack(t,e){const s=t/2,i=e/2,o=t*.4,l=e*.4,h=t*.25,a=e*.25,r=30;let c=null,g=null;for(let d=0;d<=r;d++){const u=d/r*Math.PI*2,S=1+Math.sin(u*4)*.1,p=1+Math.sin(u*4)*.1,y=new f(s+o*S*Math.cos(u),i+l*S*Math.sin(u)),b=new f(s+h*p*Math.cos(u),i+a*p*Math.sin(u));c&&g&&(this.outerWalls.push([c,y]),this.innerWalls.push([g,b]),this.checkpoints.push([b,y])),d===0&&(this.startPoint=new f((b.x+y.x)/2,(b.y+y.y)/2),this.startAngle=Math.PI/2),c=y,g=b}}draw(t){t.lineWidth=4,t.strokeStyle="#fff",t.beginPath();for(const e of this.outerWalls)t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.stroke(),t.beginPath();for(const e of this.innerWalls)t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y);t.stroke(),this.checkpoints.length>0&&(t.strokeStyle="rgba(0, 255, 0, 0.5)",t.lineWidth=2,t.beginPath(),t.moveTo(this.checkpoints[0][0].x,this.checkpoints[0][0].y),t.lineTo(this.checkpoints[0][1].x,this.checkpoints[0][1].y),t.stroke())}}function N(n,t,e,s){const i=(s.x-e.x)*(n.y-e.y)-(s.y-e.y)*(n.x-e.x),o=(e.y-n.y)*(n.x-t.x)-(e.x-n.x)*(n.y-t.y),l=(s.y-e.y)*(t.x-n.x)-(s.x-e.x)*(t.y-n.y);if(l!==0){const h=i/l,a=o/l;if(h>=0&&h<=1&&a>=0&&a<=1)return{x:n.x+h*(t.x-n.x),y:n.y+h*(t.y-n.y),offset:h}}return null}class O{pos;vel;acc;maxSpeed=5;maxForce=.2;radius=8;heading;isDead=!1;fitness=0;distanceTraveled=0;checkpointCount=0;life=500;sensorCount=5;sensorRays=[];sensorDistances=[];sensorAngles=[-Math.PI/2,-Math.PI/4,0,Math.PI/4,Math.PI/2];sensorLength=100;network;lastInputs=[0,0,0,0,0];lastOutputs=[0,0];constructor(t,e,s){this.pos=new f(t,e),this.vel=f.fromAngle(s,.1),this.acc=new f(0,0),this.heading=s,this.network=new brain.NeuralNetwork({hiddenLayers:[4,4],activation:"sigmoid"}),this.network.train([{input:[0,0,0,0,0],output:[.5,.5]}],{iterations:1}),this.scrambleWeights()}scrambleWeights(){const t=this.network.toJSON();for(let e=0;e<t.layers.length;e++)if(t.layers[e].weights){for(let s=0;s<t.layers[e].weights.length;s++)for(let i=0;i<t.layers[e].weights[s].length;i++)t.layers[e].weights[s][i]=Math.random()*4-2;for(let s=0;s<t.layers[e].biases.length;s++)t.layers[e].biases[s]=Math.random()*4-2}this.network.fromJSON(t)}update(t){if(this.isDead||(this.updateSensors(t),this.checkCollisions(t),this.isDead))return;const e=this.sensorDistances.map(a=>a/this.sensorLength);this.lastInputs=e;const s=this.network.run(e);this.lastOutputs=s;const i=s[0],o=s[1]*2-1;this.heading+=o*.1;const l=f.fromAngle(this.heading,i*this.maxForce);this.acc.add(l),this.vel.add(this.acc),this.vel.limit(this.maxSpeed),this.vel=this.vel.mult(.95);const h=new f(this.pos.x,this.pos.y);if(this.pos.add(this.vel),this.acc.mult(0),this.life--,this.life<=0){this.isDead=!0;return}this.checkCheckpoints(t,h),this.distanceTraveled+=this.vel.mag(),this.fitness=this.checkpointCount*1e3+this.distanceTraveled}checkCheckpoints(t,e){const s=this.checkpointCount%t.checkpoints.length,i=t.checkpoints[s];N(e,this.pos,i[0],i[1])&&(this.checkpointCount++,this.life+=500,this.life>1e3&&(this.life=1e3))}updateSensors(t){this.sensorRays=[],this.sensorDistances=[];const e=[...t.innerWalls,...t.outerWalls];for(let s=0;s<this.sensorCount;s++){const i=this.heading+this.sensorAngles[s],o=f.fromAngle(i,this.sensorLength),l=new f(this.pos.x+o.x,this.pos.y+o.y);let h=null,a=this.sensorLength;for(const r of e){const c=N(this.pos,l,r[0],r[1]);if(c){const g=this.pos.dist(new f(c.x,c.y));g<a&&(a=g,h=new f(c.x,c.y))}}this.sensorDistances.push(a),h?this.sensorRays.push(h):this.sensorRays.push(l)}}checkCollisions(t){const e=[...t.innerWalls,...t.outerWalls],s=new f(this.pos.x+this.vel.x,this.pos.y+this.vel.y);for(const i of e)if(N(this.pos,s,i[0],i[1])){this.isDead=!0;return}for(let i of this.sensorDistances)if(i<this.radius){this.isDead=!0;return}}draw(t,e=!1){if(!this.isDead){if(e){t.lineWidth=1;for(let s=0;s<this.sensorRays.length;s++){const i=this.sensorDistances[s]/this.sensorLength,o=Math.floor(255*(1-i)),l=Math.floor(255*i);t.strokeStyle=`rgba(${o}, ${l}, 0, 0.5)`,t.beginPath(),t.moveTo(this.pos.x,this.pos.y),t.lineTo(this.sensorRays[s].x,this.sensorRays[s].y),t.stroke()}}t.translate(this.pos.x,this.pos.y),t.rotate(this.heading),t.fillStyle=e?"#00ff00":"rgba(200, 200, 200, 0.5)",t.beginPath(),t.moveTo(this.radius,0),t.lineTo(-this.radius,-this.radius/1.5),t.lineTo(-this.radius,this.radius/1.5),t.closePath(),t.fill(),t.rotate(-this.heading),t.translate(-this.pos.x,-this.pos.y)}}}class W{populationSize=50;mutationRate=.1;boids=[];generation=1;timer=0;maxLifespan=2e3;constructor(t,e,s,i){this.populationSize=t;const o=localStorage.getItem("best_boid_brain"),l=localStorage.getItem("current_generation");l&&(this.generation=parseInt(l));for(let h=0;h<t;h++){const a=new O(e,s,i);if(o&&h===0)a.network.fromJSON(JSON.parse(o));else if(o&&h<t*.2){const r=JSON.parse(o);this.mutate(r,.2),a.network.fromJSON(r)}this.boids.push(a)}}update(t){this.timer++;let e=!0;for(const s of this.boids)s.update(t),s.isDead||(e=!1);(e||this.timer>this.maxLifespan)&&(this.nextGeneration(t.startPoint.x,t.startPoint.y,t.startAngle),this.timer=0)}nextGeneration(t,e,s){this.boids.sort((h,a)=>a.fitness-h.fitness);const i=[],o=this.boids[0],l=new O(t,e,s);l.network.fromJSON(o.network.toJSON()),i.push(l);for(let h=1;h<this.populationSize;h++){const a=new O(t,e,s),r=o.network.toJSON();this.mutate(r,this.mutationRate),a.network.fromJSON(r),i.push(a)}this.boids=i,this.generation++,localStorage.setItem("best_boid_brain",JSON.stringify(o.network.toJSON())),localStorage.setItem("current_generation",this.generation.toString())}mutate(t,e){for(let s=0;s<t.layers.length;s++)if(t.layers[s].weights){for(let i=0;i<t.layers[s].weights.length;i++)for(let o=0;o<t.layers[s].weights[i].length;o++)Math.random()<e&&(t.layers[s].weights[i][o]+=Math.random()*2-1);for(let i=0;i<t.layers[s].biases.length;i++)Math.random()<e&&(t.layers[s].biases[i]+=Math.random()*2-1)}}getBestActiveBoid(){let t=null,e=-1;for(let s of this.boids)!s.isDead&&s.fitness>e&&(e=s.fitness,t=s);return t}}function C(n,t){const e=t.network.toJSON();if(!e.layers)return;const s=n.canvas.width,i=n.canvas.height,o=[5,4,4,2],l=s/o.length,h=10,a=[];for(let r=0;r<o.length;r++){const c=o[r],g=l*r+l/2,d=[],u=(i-40)/c,S=20+u/2;for(let p=0;p<c;p++){const y=S+p*u;d.push({x:g,y})}a.push(d)}for(let r=1;r<o.length;r++){const c=o[r],g=o[r-1],d=e.layers[r-1];for(let u=0;u<c;u++){const S=a[r][u];for(let p=0;p<g;p++){const y=a[r-1][p];let b=0;d&&d.weights&&d.weights[u]&&(b=d.weights[u][p]||0);const x=Math.min(1,Math.abs(b)/2);x>.1&&(n.beginPath(),n.lineWidth=Math.abs(b)*1.5,n.strokeStyle=b>0?`rgba(0, 255, 100, ${x})`:`rgba(255, 50, 50, ${x})`,n.moveTo(y.x,y.y),n.lineTo(S.x,S.y),n.stroke())}}}for(let r=0;r<a.length;r++)for(let c=0;c<a[r].length;c++){const g=a[r][c];let d=.5;if(r===0&&t.lastInputs[c]!==void 0)d=t.lastInputs[c];else if(r===a.length-1&&t.lastOutputs[c]!==void 0)d=t.lastOutputs[c];else if(e.layers[r-1]&&e.layers[r-1].biases){const y=e.layers[r-1].biases[c];d=1/(1+Math.exp(-y))}d>.6&&(n.shadowBlur=10,n.shadowColor=`rgba(0, 255, 255, ${d})`),n.beginPath(),n.arc(g.x,g.y,h,0,Math.PI*2);const u=Math.floor(50+(1-d)*100),S=Math.floor(50+d*205),p=Math.floor(100+d*155);if(n.fillStyle=`rgb(${u}, ${S}, ${p})`,n.fill(),n.shadowBlur=0,n.strokeStyle="#fff",n.lineWidth=2,n.stroke(),r===0||r===a.length-1){n.fillStyle="#fff",n.font="10px Arial",n.textAlign="center";const y=r===0?`S${c+1}`:c===0?"T":"S";n.fillText(y,g.x,g.y+4)}}}let v,k,I,M,T=!1,m,w;const P=50;function L(){v=document.getElementById("simulation-canvas"),I=document.getElementById("network-canvas");const n=document.getElementById("simulation-container");n&&(v.width=n.clientWidth-40,v.height=n.clientHeight-40);const t=document.getElementById("network-container");t&&(I.width=t.clientWidth-20,I.height=t.clientHeight-20),k=v.getContext("2d"),M=I.getContext("2d"),m=new R(v.width,v.height),w=new W(P,m.startPoint.x,m.startPoint.y,m.startAngle);const e=document.getElementById("btn-toggle-fast");e?.addEventListener("click",()=>{T=!T,e&&(e.innerText=T?"Toggle Normal Viz":"Toggle Fast Training (No Render)")}),document.getElementById("btn-restart")?.addEventListener("click",()=>{w=new W(P,m.startPoint.x,m.startPoint.y,m.startAngle),w.generation=1}),document.getElementById("btn-clear-history")?.addEventListener("click",()=>{confirm("Clear all training history? This will reset the brain.")&&(localStorage.removeItem("best_boid_brain"),localStorage.removeItem("current_generation"),w=new W(P,m.startPoint.x,m.startPoint.y,m.startAngle),w.generation=1)}),requestAnimationFrame(D)}function B(){w.update(m)}function E(){const n=document.getElementById("generation-count"),t=document.getElementById("alive-count"),e=document.getElementById("best-fitness");n&&(n.innerText=w.generation.toString());const s=w.boids.filter(o=>!o.isDead).length;t&&(t.innerText=`${s} / ${P}`);const i=w.getBestActiveBoid();i&&e&&(e.innerText=Math.floor(i.fitness).toString())}function A(){k.clearRect(0,0,v.width,v.height),M.clearRect(0,0,I.width,I.height),m.draw(k);const n=w.getBestActiveBoid();for(const t of w.boids){const e=t===n;t.draw(k,e)}n&&(M.fillStyle="#222",M.fillRect(0,0,I.width,I.height),C(M,n)),E()}function D(){if(T){for(let n=0;n<20;n++)B();k.clearRect(0,0,v.width,v.height),k.fillStyle="white",k.fillText(`FAST TRAINING: GEN ${w.generation}`,20,30),E()}else B(),A();requestAnimationFrame(D)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();
